<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carcare.domain.vehicle.repository.VehicleBrandRepository">

    <!-- 결과 매핑 -->
    <resultMap id="VehicleBrandResultMap" type="com.carcare.domain.vehicle.entity.VehicleBrand">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="nameEn" column="name_en"/>
        <result property="code" column="code"/>
        <result property="country" column="country"/>
        <result property="description" column="description"/>
        <result property="logoUrl" column="logo_url"/>
        <result property="isActive" column="is_active"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- SQL 조각 -->
    <sql id="brandColumns">
        id, name, name_en, code, country, description, logo_url, is_active, sort_order, created_at, updated_at
    </sql>

    <!-- 제조사 등록 -->
    <insert id="insertBrand" parameterType="com.carcare.domain.vehicle.entity.VehicleBrand" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO vehicle_brands (name, name_en, code, country, description, logo_url, is_active, sort_order, created_at, updated_at)
        VALUES (#{name}, #{nameEn}, #{code}, #{country}, #{description}, #{logoUrl}, 
                COALESCE(#{isActive}, true), COALESCE(#{sortOrder}, 0), 
                COALESCE(#{createdAt}, CURRENT_TIMESTAMP), COALESCE(#{updatedAt}, CURRENT_TIMESTAMP))
    </insert>

    <!-- 제조사 정보 수정 -->
    <update id="updateBrand" parameterType="com.carcare.domain.vehicle.entity.VehicleBrand">
        UPDATE vehicle_brands
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="nameEn != null">name_en = #{nameEn},</if>
            <if test="code != null">code = #{code},</if>
            <if test="country != null">country = #{country},</if>
            <if test="description != null">description = #{description},</if>
            <if test="logoUrl != null">logo_url = #{logoUrl},</if>
            <if test="isActive != null">is_active = #{isActive},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <!-- 제조사 삭제 (소프트 삭제) -->
    <update id="deleteBrand">
        UPDATE vehicle_brands
        SET is_active = false, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- ID로 제조사 조회 -->
    <select id="findById" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE id = #{id}
    </select>

    <!-- 제조사 코드로 조회 -->
    <select id="findByCode" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE code = #{code}
    </select>

    <!-- 제조사명으로 조회 -->
    <select id="findByName" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE name = #{name}
    </select>

    <!-- 모든 활성 제조사 목록 조회 (정렬 순서별) -->
    <select id="findAllActive" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE is_active = true
        ORDER BY sort_order ASC, name ASC
    </select>

    <!-- 모든 제조사 목록 조회 (관리자용) -->
    <select id="findAll" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        ORDER BY sort_order ASC, name ASC
    </select>

    <!-- 원산지별 제조사 목록 조회 -->
    <select id="findByCountry" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE country = #{country} AND is_active = true
        ORDER BY sort_order ASC, name ASC
    </select>

    <!-- 제조사명 검색 (부분 매칭) -->
    <select id="searchByName" resultMap="VehicleBrandResultMap">
        SELECT <include refid="brandColumns"/>
        FROM vehicle_brands
        WHERE (name LIKE CONCAT('%', #{keyword}, '%') OR name_en LIKE CONCAT('%', #{keyword}, '%'))
          AND is_active = true
        ORDER BY sort_order ASC, name ASC
    </select>

    <!-- 제조사 코드 중복 검사 -->
    <select id="existsByCode" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM vehicle_brands
        WHERE code = #{code}
    </select>

    <!-- 제조사명 중복 검사 -->
    <select id="existsByName" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM vehicle_brands
        WHERE name = #{name}
    </select>

    <!-- 제조사 총 개수 -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM vehicle_brands
    </select>

    <!-- 활성 제조사 개수 -->
    <select id="countActive" resultType="int">
        SELECT COUNT(*)
        FROM vehicle_brands
        WHERE is_active = true
    </select>

</mapper> 