<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carcare.domain.notification.repository.NotificationTemplateRepository">

    <resultMap id="NotificationTemplateResultMap" type="com.carcare.domain.notification.entity.NotificationTemplate">
        <id property="id" column="id"/>
        <result property="templateUuid" column="template_uuid"/>
        <result property="name" column="name"/>
        <result property="type" column="type"/>
        <result property="channel" column="channel" typeHandler="com.carcare.common.config.NotificationChannelTypeHandler"/>
        <result property="language" column="language"/>
        <result property="subject" column="subject"/>
        <result property="titleTemplate" column="title_template"/>
        <result property="contentTemplate" column="content_template"/>
        <result property="variables" column="variables" typeHandler="com.carcare.common.config.JsonTypeHandler"/>
        <result property="isActive" column="is_active"/>
        <result property="version" column="version"/>
        <result property="description" column="description"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 템플릿 생성 -->
    <insert id="insert" parameterType="com.carcare.domain.notification.entity.NotificationTemplate" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO notification_templates (
            template_uuid, name, type, channel, language, subject,
            title_template, content_template, variables, is_active, version,
            description, created_by, updated_by, created_at, updated_at
        ) VALUES (
            #{templateUuid}, #{name}, #{type}, #{channel, typeHandler=com.carcare.common.config.NotificationChannelTypeHandler}, #{language}, #{subject},
            #{titleTemplate}, #{contentTemplate}, #{variables, typeHandler=com.carcare.common.config.JsonTypeHandler}, 
            #{isActive}, #{version}, #{description}, #{createdBy}, #{updatedBy}, #{createdAt}, #{updatedAt}
        )
    </insert>

    <!-- ID로 템플릿 조회 -->
    <select id="findById" parameterType="long" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates WHERE id = #{id}
    </select>

    <!-- UUID로 템플릿 조회 -->
    <select id="findByTemplateUuid" parameterType="string" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates WHERE template_uuid = #{templateUuid}
    </select>

    <!-- 활성 템플릿 조회 (타입 + 채널 + 언어) -->
    <select id="findActiveTemplate" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        WHERE type = #{type} 
          AND channel = #{channel} 
          AND language = #{language} 
          AND is_active = true
        ORDER BY version DESC
        LIMIT 1
    </select>

    <!-- 타입별 템플릿 목록 조회 -->
    <select id="findByType" parameterType="string" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        WHERE type = #{type}
        ORDER BY created_at DESC
    </select>

    <!-- 채널별 템플릿 목록 조회 -->
    <select id="findByChannel" parameterType="string" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        WHERE channel = #{channel}
        ORDER BY created_at DESC
    </select>

    <!-- 전체 템플릿 목록 조회 -->
    <select id="findAll" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 활성 템플릿만 조회 -->
    <select id="findActiveTemplates" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        WHERE is_active = true
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 검색 조건으로 템플릿 조회 -->
    <select id="searchTemplates" resultMap="NotificationTemplateResultMap">
        SELECT * FROM notification_templates 
        <where>
            <if test="keyword != null and keyword != ''">
                AND (name ILIKE '%' || #{keyword} || '%' 
                     OR description ILIKE '%' || #{keyword} || '%'
                     OR content_template ILIKE '%' || #{keyword} || '%')
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="channel != null and channel != ''">
                AND channel = #{channel}
            </if>
            <if test="language != null and language != ''">
                AND language = #{language}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 템플릿 개수 조회 -->
    <select id="countTemplates" resultType="int">
        SELECT COUNT(*) FROM notification_templates 
        <where>
            <if test="keyword != null and keyword != ''">
                AND (name ILIKE '%' || #{keyword} || '%' 
                     OR description ILIKE '%' || #{keyword} || '%'
                     OR content_template ILIKE '%' || #{keyword} || '%')
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="channel != null and channel != ''">
                AND channel = #{channel}
            </if>
            <if test="language != null and language != ''">
                AND language = #{language}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
    </select>

    <!-- 템플릿 업데이트 -->
    <update id="update" parameterType="com.carcare.domain.notification.entity.NotificationTemplate">
        UPDATE notification_templates SET
            name = #{name},
            type = #{type},
            channel = #{channel, typeHandler=com.carcare.common.config.NotificationChannelTypeHandler},
            language = #{language},
            subject = #{subject},
            title_template = #{titleTemplate},
            content_template = #{contentTemplate},
            variables = #{variables, typeHandler=com.carcare.common.config.JsonTypeHandler},
            is_active = #{isActive},
            version = #{version},
            description = #{description},
            updated_by = #{updatedBy},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <!-- 템플릿 활성화/비활성화 -->
    <update id="updateActiveStatus">
        UPDATE notification_templates 
        SET is_active = #{isActive}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 같은 타입/채널의 다른 템플릿 비활성화 -->
    <update id="deactivateOtherTemplates">
        UPDATE notification_templates 
        SET is_active = false, updated_at = CURRENT_TIMESTAMP
        WHERE type = #{type} 
          AND channel = #{channel} 
          AND language = #{language}
          AND id != #{excludeId}
    </update>

    <!-- 템플릿 삭제 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM notification_templates WHERE id = #{id}
    </delete>

    <!-- 템플릿 존재 여부 확인 -->
    <select id="existsByTypeAndChannel" resultType="boolean">
        SELECT COUNT(*) > 0 FROM notification_templates 
        WHERE type = #{type} AND channel = #{channel}
    </select>

</mapper> 