# 시퀀스 다이어그램 생성 로직 수정 (2025-10-19)

## 문제 현상
- CLI에서 `python -m csa.cli.main sequence --class-name UserController --project-name car-center-devlab` 실행 시 `Class 'UserController' not found in database.` 오류 발생.
- 동일한 클래스가 Neo4j `csadb01` DB에는 존재하고 있음에도 조회 실패.
- 추가로, Neo4j Cypher 실행 중 `[:CALLS*0..$max_depth]` 구문이 파라미터로 처리되지 않아 SyntaxError가 발생했고, 이후 PlantUML 렌더링 단계에서 `KeyError: 'source'` 예외가 추가로 확인됨.

## 원인 분석
1. **세션이 기본 DB(`neo4j`)에 연결됨**  
   - 시퀀스 커맨드는 커넥션 풀에서 `_ConnectionWrapper`를 받아 `SequenceDiagramGenerator`에 `driver`만 전달하고 있었다.
   - `_ConnectionWrapper.session()`을 사용할 경우 `database` 옵션이 설정되지만, 생성기에 driver만 전달되어 `driver.session()`을 직접 열 때 DB 이름이 빠져버려 `neo4j` DB로 연결됨.
   - 결과적으로 `csadb01`에 저장된 노드를 읽지 못해 “Class not found” 오류가 발생.

2. **경로 길이 파라미터 사용 불가**  
   - `fetch_call_chain` 쿼리에서 `[:CALLS*0..$max_depth]` 형태로 파라미터를 사용했는데, Neo4j는 경로 길이에 파라미터를 허용하지 않아 SyntaxError를 뱉음.

3. **이벤트 정보 부족으로 렌더링 실패**  
   - 호출 이벤트를 빌드할 때 `source`/`target`/`method` 값이 보강되지 않아 PlantUML 렌더링 시 KeyError 발생 가능성이 있었음.

## 조치 내용
1. **데이터베이스 지정**  
   - `SequenceDiagramGenerator` 생성자에 `database` 인자를 추가하고, CLI(`sequence`, `graph_queries`)에서 커넥션 풀의 DB 이름을 전달.
   - PlantUML/Mermaid 생성기가 세션을 열 때 `session(database=...)`를 사용하도록 수정.

2. **경로 길이 하드코딩**  
   - `fetch_call_chain`에서 `max_depth`를 `depth_limit = max(0, int(max_depth))`로 계산하여 f-string으로 삽입, 파라미터 오류 제거.
   - `WITH` 절에 `source_class`를 포함시켜 이후 RETURN 절에서 참조할 수 있도록 변경.

3. **호출 이벤트 보강**  
   - `build_activation_aware_flow` 결과를 렌더링하기 전에 `source`/`target`/`method`/`return_type` 필드를 기본 채워 넣어 PlantUML/Mermaid 단계에서 KeyError가 나지 않도록 함.

## 검증
- 수정 후 `python -m csa.cli.main sequence --class-name UserController --project-name car-center-devlab --format plantuml` 실행 시 다이어그램이 정상 생성되었음을 확인.
- 예: `./output/sequence-diagram/car-center-devlab/com/carcare/domain/user/controller/SEQ_UserController_changePassword_20251019-013213.puml` 등 5개 파일 저장.
