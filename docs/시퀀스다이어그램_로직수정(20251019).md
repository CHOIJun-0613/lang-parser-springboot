# 시퀀스 다이어그램 생성 로직 점검 (2025-10-19)

## 1차 진단 및 조치 현황
- `python -m csa.cli.main sequence --class-name UserController --project-name car-center-devlab` 실행 시 `Class 'UserController' not found in database.` 오류가 발생함.
- 원인: 시퀀스 CLI가 Neo4j 기본 데이터베이스(`neo4j`)로 접속하여 분석 데이터가 들어 있는 `csadb01`를 조회하지 못했던 것으로 확인됨.
- 추가 문제: `[:CALLS*0..$max_depth]` 형태의 경로 길이 파라미터가 SyntaxError를 유발했고, 이벤트 딕셔너리가 보강되지 않아 PlantUML 렌더러에서 `KeyError: 'source'`가 발생함.
- 처리 사항
  - `SequenceDiagramGenerator` 및 CLI에서 database 이름을 명시적으로 전달하도록 수정.
  - 경로 길이 파라미터를 f-string으로 주입하고 `WITH` 절에서 필요한 변수를 유지하도록 보정.
  - `build_activation_aware_flow` 결과를 렌더링 전에 `setdefault`로 보강하여 KeyError 해소.
  - PlantUML/Mermaid 두 포맷 모두 기본 동작이 정상화됨을 확인.

## 추가로 확인된 문제
1. **Mermaid 다이어그램과 실제 소스 호출 순서 불일치**
   - 호출 순서가 뒤섞이고 반환 타이밍이 어긋나 activation 박스가 실제 흐름과 다르게 표현됨.
   - 외부 라이브러리나 project_name이 비어 있는 노드가 그대로 노출되어 다이어그램이 복잡해짐.
2. **DB 호출 체인 표현 부족**
   - `Mapper → Mapper XML → SqlStatement → Table` 흐름이 다이어그램에 반영되지 않음.
   - `SqlStatement.tables`에 값이 있더라도 실제 `Table` 노드가 존재하지 않을 수 있어 보강 필요.
   - Table participant 표시 시 schema 정보를 함께 보여줄 필요가 있음.
3. **외부 호출 필터링 미비**
   - project_name이 빈 문자열/None인 노드가 포함되어 외부 호출까지 모두 표현됨. (단, Table 노드는 예외로 유지해야 함)

## 개선 계획 (Mermaid 우선 → PlantUML 순 적용)
1. **호출 플로우 정렬 및 이벤트 정규화**
   - `fetch_call_chain` Cypher를 확장하여 호출 순번(`call_order`), 호출/대상 프로젝트명, Mapper XML/SQL/Table 메타데이터를 함께 반환.
   - 반환 리스트를 순번 기준으로 정렬한 뒤 `_normalize_events()`(신규 유틸)에서 `source/target/method/return_type/project_name`을 주입. Mermaid 먼저 적용 후 PlantUML로 확장.
   - 활성화 스택을 기반으로 `return`과 `deactivate` 시점을 재계산하여 박스 길이와 리턴 순서를 실제 호출과 일치시키기.
2. **외부 호출 필터링 정책 반영**
   - `project_name`이 빈 문자열/None인 호출은 기본적으로 필터링(단, `Table` 노드는 예외).
   - Mermaid participant 구성 단계와 `should_filter_call()` 보강으로 구현하고, PlantUML에도 동일 정책 적용.
3. **DB 호출 체인 및 Table 표현 강화**
   - Cypher 단계에서 Mapper 메서드 ↔ SQL ↔ Table 관계를 모두 조인하고, `SqlStatement.tables` 목록을 사용해 실제 Table 노드를 조회.
   - Mermaid/PlantUML 모두 `Mapper class → Mapper XML → SqlStatement → Table(schema.table)` 흐름을 다이어그램에 표현.
   - `SqlStatement.tables`에 기재된 테이블이 Neo4j에 없으면 경고를 남기고 participant는 생략.
   - Table participant 라벨에 `schema`를 포함(예: `participant Orders as Orders<br/>(sales.orders)`).
4. **검증 및 확장**
   - `UserController.getUserList()`를 기준으로 Mermaid 출력이 실제 소스 호출 순서와 일치하는지 검증.
   - 동일 로직을 PlantUML에 적용하고 회귀 테스트(다른 대표 메서드 포함)를 수행.
   - 필요 시 간단한 통합 테스트를 도입해 주요 흐름이 계속 유지되는지 자동 확인.

## 수정 결과(2025-10-19 오후)
- `csa/diagrams/sequence/repository.py`를 재작성하여 Method → SQL → Table 체인을 DFS 방식으로 수집하고, `SqlStatement.columns` 기반 보조 로직과 mapper 이름 fallback을 추가했습니다.
- `csa/diagrams/sequence/mermaid.py`와 `csa/diagrams/sequence/plantuml.py`를 새 이벤트 구조에 맞게 교체해 호출 순서·반환 타이밍·외부 호출 필터링이 실제 코드와 일치하며, SQL/테이블 참여자를 명확히 표현하도록 정리했습니다.
- `python -m csa.cli.main sequence --class-name UserController --project-name car-center-devlab --image-format none` 실행 결과 Controller → Service → Mapper → SQL 흐름이 다이어그램에 반영됩니다. 단, `findUsersWithPaging` 등 일부 SQL은 Neo4j에 테이블 메타데이터가 누락되어 있어 Table 노드가 나타나지 않는 한계가 확인되었습니다.