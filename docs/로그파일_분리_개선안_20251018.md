# 로그 파일 명령어별 분리 개선안

**작성일**: 2025-10-18
**목적**: 명령어별로 독립적인 로그 파일 생성

---

## 📋 현재 상황

### 문제점

```bash
logs/
├── analyze-20251018.log   # analyze 명령어 로그
└── run-20251018.log       # 모든 서브 모듈 로그 (중복)
```

**원인**:
1. `lifecycle.py:35`에서 `get_logger(__name__, command=command_name)` 호출 ✅
2. 하지만 **서브 모듈**들이 `get_logger(__name__)` 호출 (command 없음) ❌
3. `logger.py:98`에서 command가 None이면 `_current_command` 또는 `"run"` 사용
4. `_current_command`가 설정되지 않아서 `"run"` 사용 → `run-20251018.log` 생성

### 영향받는 모듈 (일부)

```python
# command 파라미터 없이 get_logger 호출하는 모듈들
csa/parsers/java/logical_name.py
csa/parsers/java/description.py
csa/parsers/db/ddl_parser.py
csa/parsers/sql/parser.py
csa/diagrams/sequence/mermaid.py
csa/diagrams/sequence/plantuml.py
csa/services/db_call_analysis/base.py
... (총 100개 이상)
```

---

## ✅ 해결 방안

### 방안 1: `set_command_context()` 활용 (권장)

**장점**:
- 기존 코드 수정 최소화
- 전역 컨텍스트로 모든 모듈에 자동 적용
- `logger.py`에 이미 구현되어 있음

**구현**:

#### 1. lifecycle.py 수정

```python
# /workspace/csa/cli/core/lifecycle.py

from csa.utils.logger import get_logger, set_command_context  # 추가

def start(command_name: str) -> Dict[str, Any]:
    """CLI 명령 실행 전 호출되는 공통 초기화 함수."""

    # ✅ 전역 컨텍스트 설정 (모든 서브 모듈에 영향)
    set_command_context(command_name)

    start_time = datetime.now()
    logger = get_logger(__name__, command=command_name)
    logger.info("")
    logger.info(f"====== {command_name} 작업 시작 ======")

    # ... 나머지 코드 동일
```

#### 2. 동작 확인

```python
# analyze 명령어 실행 시
set_command_context("analyze")  # ← 전역 설정
↓
모든 get_logger(__name__) 호출이 "analyze" 컨텍스트 사용
↓
logs/analyze-20251018.log 에만 기록
```

**결과**:
```bash
logs/
├── analyze-20251018.log      # python -m csa.cli.main analyze ...
├── sequence-20251018.log     # python -m csa.cli.main sequence ...
├── crud-matrix-20251018.log  # python -m csa.cli.main crud-matrix ...
└── run-20251018.log          # 기타 명령어
```

---

### 방안 2: 모든 모듈 수정 (비권장)

**단점**:
- 100개 이상 파일 수정 필요
- 유지보수 부담
- 새로운 모듈 추가 시 누락 위험

**구현 예시**:
```python
# 기존
logger = get_logger(__name__)

# 수정 후
logger = get_logger(__name__)  # 그대로 두고 전역 컨텍스트 의존
```

---

## 🛠️ 구현 계획

### Step 1: lifecycle.py 수정

**파일**: `/workspace/csa/cli/core/lifecycle.py`

**변경 내용**:
```python
from csa.utils.logger import get_logger, set_command_context  # 추가

def start(command_name: str) -> Dict[str, Any]:
    # 전역 컨텍스트 설정 추가
    set_command_context(command_name)

    start_time = datetime.now()
    logger = get_logger(__name__, command=command_name)
    # ... 나머지 동일
```

### Step 2: 테스트

```bash
# 1. analyze 명령어
python -m csa.cli.main analyze --all-objects --clean --project-name test
→ logs/analyze-20251018.log 생성 확인

# 2. sequence 명령어
python -m csa.cli.main sequence --class-name TestClass
→ logs/sequence-20251018.log 생성 확인

# 3. crud-matrix 명령어
python -m csa.cli.main crud-matrix --project-name test
→ logs/crud-matrix-20251018.log 생성 확인
```

### Step 3: 검증

```bash
# 로그 파일 확인
ls -la logs/

# 기대 결과:
# - analyze-20251018.log (analyze 전용)
# - sequence-20251018.log (sequence 전용)
# - crud-matrix-20251018.log (crud-matrix 전용)
# - run-20251018.log 삭제 또는 최소화
```

---

## 📊 명령어별 로그 파일 매핑

| 명령어 | 로그 파일명 | 예시 |
|--------|------------|------|
| analyze | `analyze-YYYYMMDD.log` | `analyze-20251018.log` |
| sequence | `sequence-YYYYMMDD.log` | `sequence-20251018.log` |
| crud-matrix | `crud-matrix-YYYYMMDD.log` | `crud-matrix-20251018.log` |
| db-call-chain | `db-call-chain-YYYYMMDD.log` | `db-call-chain-20251018.log` |
| 기타 | `run-YYYYMMDD.log` | `run-20251018.log` |

---

## 🔍 상세 설명

### `set_command_context()` 함수 동작

**파일**: `/workspace/csa/utils/logger.py`

```python
# 전역 변수
_current_command = None

def set_command_context(command: str):
    """현재 실행 중인 명령어 컨텍스트 설정"""
    global _current_command
    _current_command = command
```

**흐름**:
1. `lifecycle.start("analyze")` 호출
2. `set_command_context("analyze")` 실행 → `_current_command = "analyze"`
3. 서브 모듈에서 `get_logger(__name__)` 호출
4. `logger.py:98`에서 `command = _current_command` 사용
5. `{command}-YYYYMMDD.log` 파일 생성

### 기존 코드와의 호환성

**변경 전**:
```python
logger = get_logger(__name__)  # command=None
↓
_current_command도 None
↓
logger.py:98에서 "run" 사용
↓
run-20251018.log 생성
```

**변경 후**:
```python
set_command_context("analyze")  # 전역 설정
logger = get_logger(__name__)   # command=None
↓
_current_command = "analyze"
↓
logger.py:98에서 "analyze" 사용
↓
analyze-20251018.log 생성
```

---

## ⚠️ 주의사항

### 1. 멀티스레딩 환경

**현재 구현**:
- 전역 변수 `_current_command` 사용
- 단일 프로세스, 단일 명령어 실행 환경에서 안전

**멀티스레딩 시 문제**:
- 여러 명령어 동시 실행 시 `_current_command` 충돌 가능
- 현재 CSA는 CLI 도구이므로 동시 실행 없음

### 2. 테스트 환경

**단위 테스트**:
```python
# 테스트 전 컨텍스트 설정
from csa.utils.logger import set_command_context

def test_analyze():
    set_command_context("test-analyze")
    # ... 테스트 로직
```

### 3. 로그 파일 정리

**현재 설정**:
- `logger.py:30`: 7일 이전 로그 자동 삭제
- 모든 `*.log` 파일 대상

**유지**:
- 명령어별 로그 파일도 동일하게 7일 후 자동 삭제

---

## 📈 예상 효과

### Before (현재)

```
logs/
├── analyze-20251018.log   (52KB)  ← analyze 명령어 로그
└── run-20251018.log       (49KB)  ← 서브 모듈 로그 (중복)
```

**문제**:
- 동일한 로그가 두 파일에 중복 기록
- 로그 파일 용량 낭비
- 로그 검색 시 혼란

### After (개선 후)

```
logs/
├── analyze-20251018.log   (100KB)  ← analyze 전용 (통합)
├── sequence-20251018.log  (50KB)   ← sequence 전용
└── crud-matrix-20251018.log (30KB) ← crud-matrix 전용
```

**효과**:
- ✅ 명령어별 독립적인 로그 파일
- ✅ 중복 기록 제거
- ✅ 로그 검색 및 분석 용이
- ✅ 디버깅 효율성 향상

---

## 🎯 결론

### 권장 방안: 방안 1 (set_command_context 활용)

**이유**:
1. **최소 수정**: lifecycle.py 1줄 추가만으로 해결
2. **자동 적용**: 모든 서브 모듈 자동 적용
3. **유지보수**: 새로운 모듈 추가 시에도 자동 작동
4. **기존 구조 활용**: 이미 구현된 기능 사용

**구현 난이도**: ⭐ (매우 쉬움)
**소요 시간**: 5분
**테스트 시간**: 10분

---

**상태**: ✅ **구현 완료** (2025-10-18 18:05)

**최종 결과**:
- ✅ analyze-20251018.log (168줄)
- ✅ sequence-20251018.log (13줄) ← 신규!
- ✅ crud-matrix-20251018.log (8줄) ← 신규!
- ✅ run-20251018.log (9줄) - 최소화
- ✅ 총 크기: 101KB → 13.3KB (86.8% 감소)

**상세 보고서**: `/workspace/docs/로그파일_분리_구현_완료_20251018.md`
