# JSON íŒŒì‹± ë¡œì§ ì¤‘ë³µ ì œê±° ì‘ì—…

**ì‘ì„±ì¼**: 2025-10-20
**ì‘ì—…ì**: Claude Code
**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ Medium
**ì˜ˆìƒ ì‹œê°„**: 1ì‹œê°„

---

## ğŸ“‹ ì‘ì—… ê°œìš”

ë™ì¼í•œ JSON íŒŒì‹± íŒ¨í„´ì´ `get_class_info()`, `get_methods()`, `get_fields()` ë“± ì—¬ëŸ¬ ë©”ì„œë“œì—ì„œ ë°˜ë³µë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.

---

## ğŸ› ë¬¸ì œ ìƒí™©

### ì½”ë“œ ì¤‘ë³µ
```python
# get_class_info()ì—ì„œ
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# get_methods()ì—ì„œ (ë™ì¼í•œ íŒ¨í„´)
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# get_fields()ì—ì„œ (ë™ì¼í•œ íŒ¨í„´)
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []
```

### ë¬¸ì œì 
1. **DRY ì›ì¹™ ìœ„ë°˜**: ë™ì¼í•œ ì½”ë“œê°€ 10íšŒ ì´ìƒ ë°˜ë³µ
2. **ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€**: ë¡œì§ ë³€ê²½ ì‹œ ì—¬ëŸ¬ ê³³ ìˆ˜ì • í•„ìš”
3. **ì—ëŸ¬ ë¡œê¹… ëˆ„ë½**: íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì–´ë ¤ì›€
4. **í…ŒìŠ¤íŠ¸ ì¤‘ë³µ**: ê° ë©”ì„œë“œë§ˆë‹¤ ë™ì¼í•œ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ í•„ìš”

---

## ğŸ”§ í•´ê²° ë°©ì•ˆ

### í—¬í¼ ë©”ì„œë“œ ì¶”ê°€
```python
def _parse_json_field(
    self,
    value: Any,
    default: Any = None,
    field_name: str = ""
) -> Any:
    """
    JSON í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±

    Args:
        value: íŒŒì‹±í•  ê°’ (str, list, dict, None)
        default: íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ (ê¸°ë³¸: [])
        field_name: í•„ë“œëª… (ë¡œê¹…ìš©)

    Returns:
        íŒŒì‹±ëœ ê°’ ë˜ëŠ” ê¸°ë³¸ê°’
    """
    # None ë˜ëŠ” ë¹ˆ ê°’ ì²˜ë¦¬
    if not value:
        return default if default is not None else []

    # ì´ë¯¸ ë¦¬ìŠ¤íŠ¸/ë”•ì…”ë„ˆë¦¬ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if isinstance(value, (list, dict)):
        return value

    # ë¬¸ìì—´ì¸ ê²½ìš° JSON íŒŒì‹±
    if isinstance(value, str):
        try:
            parsed = json.loads(value)
            return parsed if parsed else (default if default is not None else [])
        except json.JSONDecodeError as e:
            logger.warning(
                f"Failed to parse JSON field '{field_name}': {e}, "
                f"value: {value[:100]}..."
            )
            return default if default is not None else []

    # ê¸°íƒ€ íƒ€ì…ì€ ê·¸ëŒ€ë¡œ ë°˜í™˜
    return value
```

---

## ğŸ“ ìˆ˜ì • ê³„íš

### Step 1: í—¬í¼ ë©”ì„œë“œ ì¶”ê°€
**íŒŒì¼**: `csa/services/class_spec/repository.py`

**ìœ„ì¹˜**: ClassSpecRepository í´ë˜ìŠ¤ ë‚´ë¶€ (Line ~20)

**ì½”ë“œ**:
```python
class ClassSpecRepository:
    """í´ë˜ìŠ¤ ëª…ì„¸ì„œ ìƒì„±ì„ ìœ„í•œ Neo4j ë°ì´í„° ì¡°íšŒ í´ë˜ìŠ¤"""

    def __init__(self, driver: Driver, database: Optional[str] = None):
        self.driver = driver
        self.database = database or "neo4j"

    def _parse_json_field(self, value: Any, default: Any = None, field_name: str = "") -> Any:
        """JSON í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±"""
        # (ìœ„ ì½”ë“œ ì°¸ì¡°)
```

---

### Step 2: get_class_info() ë¦¬íŒ©í† ë§

**Before** (8ì¤„):
```python
# Annotations íŒŒì‹±
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Interfaces íŒŒì‹±
interfaces = record["interfaces"] or []
if isinstance(interfaces, str):
    try:
        interfaces = json.loads(interfaces)
    except json.JSONDecodeError:
        interfaces = []
```

**After** (2ì¤„):
```python
# Annotations íŒŒì‹±
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Interfaces íŒŒì‹±
interfaces = self._parse_json_field(record["interfaces"], [], "interfaces")
```

---

### Step 3: get_methods() ë¦¬íŒ©í† ë§

**Before** (16ì¤„):
```python
# Annotations íŒŒì‹±
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Modifiers íŒŒì‹±
modifiers = record["modifiers"] or []
if isinstance(modifiers, str):
    try:
        modifiers = json.loads(modifiers)
    except json.JSONDecodeError:
        modifiers = []
```

**After** (2ì¤„):
```python
# Annotations íŒŒì‹±
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Modifiers íŒŒì‹±
modifiers = self._parse_json_field(record["modifiers"], [], "modifiers")
```

---

### Step 4: get_fields() ë¦¬íŒ©í† ë§

**Before** (16ì¤„):
```python
# Annotations íŒŒì‹±
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Modifiers íŒŒì‹±
modifiers = record["modifiers"] or []
if isinstance(modifiers, str):
    try:
        modifiers = json.loads(modifiers)
    except json.JSONDecodeError:
        modifiers = []
```

**After** (2ì¤„):
```python
# Annotations íŒŒì‹±
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Modifiers íŒŒì‹±
modifiers = self._parse_json_field(record["modifiers"], [], "modifiers")
```

---

## ğŸ“Š íš¨ê³¼

### ì½”ë“œ ë¼ì¸ ìˆ˜ ê°ì†Œ
- **Before**: ~60ì¤„ (íŒŒì‹± ë¡œì§)
- **After**: ~25ì¤„ (í—¬í¼ + í˜¸ì¶œ)
- **ê°ì†Œ**: 58% ê°ì†Œ

### ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- íŒŒì‹± ë¡œì§ ë³€ê²½ ì‹œ 1ê³³ë§Œ ìˆ˜ì •
- ì—ëŸ¬ ë¡œê¹… ìë™ ì¶”ê°€
- í…ŒìŠ¤íŠ¸ ì½”ë“œ 1ê³³ë§Œ ì‘ì„±

### ë””ë²„ê¹… ê°œì„ 
```
# ê¸°ì¡´: ì—ëŸ¬ ë°œìƒ ì‹œ ì•„ë¬´ ë¡œê·¸ ì—†ìŒ
# ê°œì„ : ìƒì„¸í•œ ê²½ê³  ë¡œê·¸
WARNING: Failed to parse JSON field 'annotations': Expecting value: line 1 column 1 (char 0), value: [invalid json...
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê³„íš

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```python
def test_parse_json_field():
    repo = ClassSpecRepository(None, None)

    # ì •ìƒ ì¼€ì´ìŠ¤
    assert repo._parse_json_field('["a", "b"]', [], "test") == ["a", "b"]
    assert repo._parse_json_field(["a", "b"], [], "test") == ["a", "b"]

    # None/ë¹ˆ ê°’
    assert repo._parse_json_field(None, [], "test") == []
    assert repo._parse_json_field("", [], "test") == []

    # ì˜ëª»ëœ JSON
    assert repo._parse_json_field("[invalid", [], "test") == []

    # ê¸°ë³¸ê°’ ì»¤ìŠ¤í„°ë§ˆì´ì§•
    assert repo._parse_json_field(None, {"custom": "default"}, "test") == {"custom": "default"}
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NotificationRepository
```

**ê¸°ëŒ€ ê²°ê³¼**:
- âœ… ê¸°ì¡´ê³¼ ë™ì¼í•œ ê²°ê³¼ ìƒì„±
- âœ… íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì— WARNING ì¶œë ¥

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Step 1: `_parse_json_field()` í—¬í¼ ë©”ì„œë“œ ì¶”ê°€
- [ ] Step 2: `get_class_info()` ë¦¬íŒ©í† ë§
- [ ] Step 3: `get_methods()` ë¦¬íŒ©í† ë§
- [ ] Step 4: `get_fields()` ë¦¬íŒ©í† ë§
- [ ] í…ŒìŠ¤íŠ¸ 1: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ì„ íƒ)
- [ ] í…ŒìŠ¤íŠ¸ 2: í†µí•© í…ŒìŠ¤íŠ¸ (í•„ìˆ˜)
- [ ] ë¡œê·¸ í™•ì¸: WARNING ë©”ì‹œì§€ ì •ìƒ ì¶œë ¥
- [ ] Git commit

---

## ğŸ¯ ì™„ë£Œ ê¸°ì¤€

1. âœ… ì¤‘ë³µ ì½”ë“œ ì œê±° (60ì¤„ â†’ 25ì¤„)
2. âœ… ê¸°ëŠ¥ ì •ìƒ ì‘ë™ (ëª…ì„¸ì„œ ìƒì„±)
3. âœ… íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì¶œë ¥

---

## ğŸ“ ì‘ì—… ë¡œê·¸

### ì‹œì‘ ì‹œê°„
- 2025-10-20 21:00:00

### ì¢…ë£Œ ì‹œê°„
- (ì‘ì—… ì™„ë£Œ í›„ ê¸°ë¡)

### ì‹¤ì œ ì†Œìš” ì‹œê°„
- (ì‘ì—… ì™„ë£Œ í›„ ê¸°ë¡)

### ì´ìŠˆ/íŠ¹ì´ì‚¬í•­
- (ì‘ì—… ì¤‘ ë°œê²¬ëœ ì´ìŠˆ ê¸°ë¡)
