# JSON 파싱 로직 중복 제거 작업

**작성일**: 2025-10-20
**작업자**: Claude Code
**우선순위**: 🟡 Medium
**예상 시간**: 1시간

---

## 📋 작업 개요

동일한 JSON 파싱 패턴이 `get_class_info()`, `get_methods()`, `get_fields()` 등 여러 메서드에서 반복되는 문제를 해결합니다.

---

## 🐛 문제 상황

### 코드 중복
```python
# get_class_info()에서
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# get_methods()에서 (동일한 패턴)
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# get_fields()에서 (동일한 패턴)
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []
```

### 문제점
1. **DRY 원칙 위반**: 동일한 코드가 10회 이상 반복
2. **유지보수 어려움**: 로직 변경 시 여러 곳 수정 필요
3. **에러 로깅 누락**: 파싱 실패 시 디버깅 어려움
4. **테스트 중복**: 각 메서드마다 동일한 케이스 테스트 필요

---

## 🔧 해결 방안

### 헬퍼 메서드 추가
```python
def _parse_json_field(
    self,
    value: Any,
    default: Any = None,
    field_name: str = ""
) -> Any:
    """
    JSON 필드를 안전하게 파싱

    Args:
        value: 파싱할 값 (str, list, dict, None)
        default: 파싱 실패 시 기본값 (기본: [])
        field_name: 필드명 (로깅용)

    Returns:
        파싱된 값 또는 기본값
    """
    # None 또는 빈 값 처리
    if not value:
        return default if default is not None else []

    # 이미 리스트/딕셔너리면 그대로 반환
    if isinstance(value, (list, dict)):
        return value

    # 문자열인 경우 JSON 파싱
    if isinstance(value, str):
        try:
            parsed = json.loads(value)
            return parsed if parsed else (default if default is not None else [])
        except json.JSONDecodeError as e:
            logger.warning(
                f"Failed to parse JSON field '{field_name}': {e}, "
                f"value: {value[:100]}..."
            )
            return default if default is not None else []

    # 기타 타입은 그대로 반환
    return value
```

---

## 📝 수정 계획

### Step 1: 헬퍼 메서드 추가
**파일**: `csa/services/class_spec/repository.py`

**위치**: ClassSpecRepository 클래스 내부 (Line ~20)

**코드**:
```python
class ClassSpecRepository:
    """클래스 명세서 생성을 위한 Neo4j 데이터 조회 클래스"""

    def __init__(self, driver: Driver, database: Optional[str] = None):
        self.driver = driver
        self.database = database or "neo4j"

    def _parse_json_field(self, value: Any, default: Any = None, field_name: str = "") -> Any:
        """JSON 필드를 안전하게 파싱"""
        # (위 코드 참조)
```

---

### Step 2: get_class_info() 리팩토링

**Before** (8줄):
```python
# Annotations 파싱
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Interfaces 파싱
interfaces = record["interfaces"] or []
if isinstance(interfaces, str):
    try:
        interfaces = json.loads(interfaces)
    except json.JSONDecodeError:
        interfaces = []
```

**After** (2줄):
```python
# Annotations 파싱
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Interfaces 파싱
interfaces = self._parse_json_field(record["interfaces"], [], "interfaces")
```

---

### Step 3: get_methods() 리팩토링

**Before** (16줄):
```python
# Annotations 파싱
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Modifiers 파싱
modifiers = record["modifiers"] or []
if isinstance(modifiers, str):
    try:
        modifiers = json.loads(modifiers)
    except json.JSONDecodeError:
        modifiers = []
```

**After** (2줄):
```python
# Annotations 파싱
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Modifiers 파싱
modifiers = self._parse_json_field(record["modifiers"], [], "modifiers")
```

---

### Step 4: get_fields() 리팩토링

**Before** (16줄):
```python
# Annotations 파싱
annotations = record["annotations"] or []
if isinstance(annotations, str):
    try:
        annotations = json.loads(annotations)
    except json.JSONDecodeError:
        annotations = []

# Modifiers 파싱
modifiers = record["modifiers"] or []
if isinstance(modifiers, str):
    try:
        modifiers = json.loads(modifiers)
    except json.JSONDecodeError:
        modifiers = []
```

**After** (2줄):
```python
# Annotations 파싱
annotations = self._parse_json_field(record["annotations"], [], "annotations")

# Modifiers 파싱
modifiers = self._parse_json_field(record["modifiers"], [], "modifiers")
```

---

## 📊 효과

### 코드 라인 수 감소
- **Before**: ~60줄 (파싱 로직)
- **After**: ~25줄 (헬퍼 + 호출)
- **감소**: 58% 감소

### 유지보수성 향상
- 파싱 로직 변경 시 1곳만 수정
- 에러 로깅 자동 추가
- 테스트 코드 1곳만 작성

### 디버깅 개선
```
# 기존: 에러 발생 시 아무 로그 없음
# 개선: 상세한 경고 로그
WARNING: Failed to parse JSON field 'annotations': Expecting value: line 1 column 1 (char 0), value: [invalid json...
```

---

## ✅ 테스트 계획

### 1. 단위 테스트
```python
def test_parse_json_field():
    repo = ClassSpecRepository(None, None)

    # 정상 케이스
    assert repo._parse_json_field('["a", "b"]', [], "test") == ["a", "b"]
    assert repo._parse_json_field(["a", "b"], [], "test") == ["a", "b"]

    # None/빈 값
    assert repo._parse_json_field(None, [], "test") == []
    assert repo._parse_json_field("", [], "test") == []

    # 잘못된 JSON
    assert repo._parse_json_field("[invalid", [], "test") == []

    # 기본값 커스터마이징
    assert repo._parse_json_field(None, {"custom": "default"}, "test") == {"custom": "default"}
```

### 2. 통합 테스트
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NotificationRepository
```

**기대 결과**:
- ✅ 기존과 동일한 결과 생성
- ✅ 파싱 실패 시 로그에 WARNING 출력

---

## 📋 체크리스트

- [ ] Step 1: `_parse_json_field()` 헬퍼 메서드 추가
- [ ] Step 2: `get_class_info()` 리팩토링
- [ ] Step 3: `get_methods()` 리팩토링
- [ ] Step 4: `get_fields()` 리팩토링
- [ ] 테스트 1: 단위 테스트 (선택)
- [ ] 테스트 2: 통합 테스트 (필수)
- [ ] 로그 확인: WARNING 메시지 정상 출력
- [ ] Git commit

---

## 🎯 완료 기준

1. ✅ 중복 코드 제거 (60줄 → 25줄)
2. ✅ 기능 정상 작동 (명세서 생성)
3. ✅ 파싱 실패 시 로그 출력

---

## 📝 작업 로그

### 시작 시간
- 2025-10-20 21:00:00

### 종료 시간
- (작업 완료 후 기록)

### 실제 소요 시간
- (작업 완료 후 기록)

### 이슈/특이사항
- (작업 중 발견된 이슈 기록)
