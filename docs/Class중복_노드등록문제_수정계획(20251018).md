# Class ì¤‘ë³µ ë…¸ë“œ ë“±ë¡ ë¬¸ì œ ìˆ˜ì • ê³„íš

**ì‘ì„±ì¼**: 2025-10-18
**ì‘ì„±ì**: Claude Code
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ“‹ ëª©ì°¨

1. [ë¬¸ì œ ìš”ì•½](#ë¬¸ì œ-ìš”ì•½)
2. [ê·¼ë³¸ ì›ì¸](#ê·¼ë³¸-ì›ì¸)
3. [ì˜í–¥ ë²”ìœ„](#ì˜í–¥-ë²”ìœ„)
4. [ê°œì„  ì „ëµ](#ê°œì„ -ì „ëµ)
5. [ìƒì„¸ êµ¬í˜„ ê³„íš](#ìƒì„¸-êµ¬í˜„-ê³„íš)
6. [í…ŒìŠ¤íŠ¸ ì „ëµ](#í…ŒìŠ¤íŠ¸-ì „ëµ)
7. [ì‹¤í–‰ ê³„íš](#ì‹¤í–‰-ê³„íš)
8. [ì£¼ì˜ì‚¬í•­](#ì£¼ì˜ì‚¬í•­)
9. [ì§„í–‰ ìƒí™©](#ì§„í–‰-ìƒí™©)
10. [ìˆ˜ì • ì™„ë£Œ ìƒì„¸ ë‚´ìš©](#ìˆ˜ì •-ì™„ë£Œ-ìƒì„¸-ë‚´ìš©)
11. [í•´ê²°ëœ ë¬¸ì œ](#í•´ê²°ëœ-ë¬¸ì œ)
12. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)
13. [ì°¸ê³  ì‚¬í•­](#ì°¸ê³ -ì‚¬í•­)
14. [ë¬¸ì„œ ì´ë ¥](#ë¬¸ì„œ-ì´ë ¥)

---

## ë¬¸ì œ ìš”ì•½

### í˜„ì¬ ìƒí™©

- **ì¤‘ë³µ Class ë…¸ë“œ**: 31ê°œ í´ë˜ìŠ¤ê°€ 2~3ê°œì”© ì¤‘ë³µ ìƒì„±ë¨
- **ë¹ˆ ì†ì„± ë…¸ë“œ**: 653ê°œì˜ Class ë…¸ë“œê°€ `project_name`, `package`, `file_path` ì—†ì´ ìƒì„±ë¨
- **ê·¼ë³¸ ì›ì¸**: MERGE ì¡°ê±´ ë¶ˆì¼ì¹˜

### ë°ì´í„° ê²€ì¦

#### VehicleValidator ì˜ˆì‹œ

| elementId | name | package | project_name | file_path | ìƒì„± ì›ì¸ |
|-----------|------|---------|--------------|-----------|----------|
| 268 | VehicleValidator | NULL | NULL | NULL | **ë©”ì„œë“œ í˜¸ì¶œ ê´€ê³„ ìƒì„± ì‹œ** |
| 499 | VehicleValidator | com.carcare...validator | car-center-devlab | target_src/.../VehicleValidator.java | **ì •ìƒ íŒŒì‹±** |

#### í†µê³„

```
ì´ Class ë…¸ë“œ: 789ê°œ
â”œâ”€ ì •ìƒ ë…¸ë“œ (project_name + file_path ìˆìŒ): 136ê°œ
â”œâ”€ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë…¸ë“œ (ë‘˜ ë‹¤ ì—†ìŒ): 653ê°œ
â””â”€ ì´ ì¤‘ í”„ë¡œì íŠ¸ ë‚´ë¶€ í´ë˜ìŠ¤ì™€ ì¤‘ë³µ: 31ê°œ
```

#### ì¤‘ë³µëœ í´ë˜ìŠ¤

```
- SmsService (3ê°œ)
- VehicleValidator (2ê°œ)
- PaymentService (2ê°œ)
- UserMapper (2ê°œ)
- Payment (2ê°œ)
... ì™¸ 26ê°œ í´ë˜ìŠ¤
```

---

## ê·¼ë³¸ ì›ì¸

### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ

#### 1. Import ì²˜ë¦¬ ë¡œì§ (`project_nodes.py:170-180`)

```python
for import_class in class_node.imports:
    import_query = (
        "MERGE (imp:Class {name: $import_class}) "  # âŒ ë¬¸ì œ: nameë§Œìœ¼ë¡œ MERGE
        "MERGE (c:Class {name: $class_name}) "
        "MERGE (c)-[:IMPORTS]->(imp)"
    )
    tx.run(
        import_query,
        import_class=import_class,
        class_name=class_node.name,
    )
```

#### 2. ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§ (`project_nodes.py:468-474`)

```python
target_class_query = (
    "MERGE (tc:Class {name: $target_class})"  # âŒ ë¬¸ì œ: nameë§Œìœ¼ë¡œ MERGE
)
tx.run(
    target_class_query,
    target_class=method_call.target_class,
)
```

#### 3. Superclass ì²˜ë¦¬ ë¡œì§ (`project_nodes.py:193-203`)

```python
if class_node.superclass:
    superclass_query = (
        "MERGE (super:Class {name: $superclass}) "  # âŒ ë¬¸ì œ: nameë§Œìœ¼ë¡œ MERGE
        "MERGE (c:Class {name: $class_name}) "
        "MERGE (c)-[:EXTENDS]->(super)"
    )
```

### MERGE ì¡°ê±´ ë¶ˆì¼ì¹˜

**ì •ìƒ Class ë…¸ë“œ ìƒì„± ì‹œ (123ë²ˆ ë¼ì¸):**
```cypher
MERGE (c:Class {name: $name, package: $package})  # âœ“ name + package ì¡°í•©
```

**Import/í˜¸ì¶œ ì‹œ ë¹ˆ ë…¸ë“œ ìƒì„±:**
```cypher
MERGE (imp:Class {name: $import_class})  # âœ— nameë§Œ ì‚¬ìš©
```

**ê²°ê³¼:**
- Neo4jëŠ” `{name: "VehicleValidator", package: NULL}`ì„ ë³„ë„ì˜ ë…¸ë“œë¡œ ì¸ì‹
- ë™ì¼ ì´ë¦„ì˜ í´ë˜ìŠ¤ê°€ ì¤‘ë³µ ìƒì„±ë¨

---

## ì˜í–¥ ë²”ìœ„

### ê¸°ëŠ¥ì  ì˜í–¥

- âŒ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ìƒì„± ì‹œ ì˜ëª»ëœ ë…¸ë“œ ì°¸ì¡° ê°€ëŠ¥
- âŒ CRUD ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ì„ ì‹œ ë°ì´í„° ëˆ„ë½
- âŒ í˜¸ì¶œ ê´€ê³„ ë¶„ì„ì˜ ì •í™•ë„ ì €í•˜

### ì„±ëŠ¥ ì˜í–¥

- âš ï¸ ê·¸ë˜í”„ ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜ (ì¤‘ë³µ ë…¸ë“œ íƒìƒ‰)
- âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ í¬ê¸° ì¦ê°€ (ì•½ 30% ì´ìƒ)

### ë°ì´í„° ì •í•©ì„±

- âŒ 31ê°œ í´ë˜ìŠ¤ì˜ ì¤‘ë³µ ë°ì´í„°
- âŒ ê´€ê³„ ì •ë³´ ë¶„ì‚°

---

## ê°œì„  ì „ëµ

### Phase 1: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€ âœ… ìš°ì„ ìˆœìœ„: HIGH

ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒë³„ ë¡œì§ì„ ê³µí†µ ëª¨ë“ˆë¡œ ì¶”ì¶œ

- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìë™ ê°ì§€
- Full qualified name íŒŒì‹±
- í´ë˜ìŠ¤ ì‹ë³„ì ì •ê·œí™”

### Phase 2: ì½”ë“œ ìˆ˜ì • âœ… ìš°ì„ ìˆœìœ„: HIGH

`project_nodes.py`ì˜ Class ë…¸ë“œ ìƒì„± ë¡œì§ ê°œì„ 

- Import ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- Superclass/Interface ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •

### Phase 3: ë°ì´í„° ì •ë¦¬ âœ… ìš°ì„ ìˆœìœ„: MEDIUM

ê¸°ì¡´ ì¤‘ë³µ ë…¸ë“œ ë³‘í•© ë° ì •ë¦¬

- ì¤‘ë³µ ë…¸ë“œ ì‹ë³„
- ë³‘í•© ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- Dry-runìœ¼ë¡œ ì•ˆì „ì„± í™•ë³´

---

## ìƒì„¸ êµ¬í˜„ ê³„íš

### Phase 1: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€

#### íŒŒì¼: `/workspace/csa/utils/class_helpers.py` (ì‹ ê·œ)

```python
"""Class ë…¸ë“œ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜"""

from typing import Optional


def is_external_library(class_name: str, package: Optional[str] = None) -> bool:
    """
    ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í´ë˜ìŠ¤ì¸ì§€ íŒë³„

    Args:
        class_name: í´ë˜ìŠ¤ëª… (full qualified name ë˜ëŠ” simple name)
        package: íŒ¨í‚¤ì§€ëª… (ì„ íƒì )

    Returns:
        ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë©´ True, í”„ë¡œì íŠ¸ ë‚´ë¶€ì´ë©´ False
    """
    if "." in class_name and not package:
        parts = class_name.rsplit(".", 1)
        if len(parts) == 2:
            package = parts[0]

    if not package:
        return True

    external_prefixes = (
        "java.",
        "javax.",
        "jakarta.",
        "org.springframework.",
        "org.apache.",
        "org.hibernate.",
        "lombok.",
        "com.fasterxml.jackson.",
        "org.slf4j.",
        "ch.qos.logback.",
    )

    return package.startswith(external_prefixes)


def extract_package_from_full_name(full_name: str) -> tuple[str, Optional[str]]:
    """
    Full qualified nameì—ì„œ í´ë˜ìŠ¤ëª…ê³¼ íŒ¨í‚¤ì§€ ë¶„ë¦¬

    Args:
        full_name: ì „ì²´ í´ë˜ìŠ¤ëª…

    Returns:
        (class_name, package) íŠœí”Œ
    """
    if "." not in full_name:
        return full_name, None

    parts = full_name.rsplit(".", 1)
    return parts[1], parts[0]


def normalize_class_identifier(
    class_name: str,
    package: Optional[str] = None
) -> dict[str, Optional[str]]:
    """
    Class ë…¸ë“œ ì‹ë³„ìë¥¼ ì •ê·œí™”

    Args:
        class_name: í´ë˜ìŠ¤ëª…
        package: íŒ¨í‚¤ì§€ëª…

    Returns:
        ì •ê·œí™”ëœ ì‹ë³„ì dict
    """
    if "." in class_name and not package:
        class_name, extracted_package = extract_package_from_full_name(class_name)
        package = package or extracted_package

    if "$" in class_name:
        class_name = class_name.split("$")[0]

    return {
        "name": class_name,
        "package": package,
    }
```

### Phase 2: ì½”ë“œ ìˆ˜ì •

#### ìˆ˜ì • 1: Import ì²˜ë¦¬ ë¡œì§

**íŒŒì¼**: `/workspace/csa/services/graph_db/project_nodes.py`
**ë¼ì¸**: 170-180

**ê°œì„ ëœ ì½”ë“œ**:
```python
from csa.utils.class_helpers import (
    is_external_library,
    extract_package_from_full_name,
)

for import_class in class_node.imports:
    if is_external_library(import_class):
        # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” nameë§Œìœ¼ë¡œ MERGE
        import_query = (
            "MERGE (imp:Class {name: $import_class}) "
            "SET imp.is_external = true "
            "WITH imp "
            "MATCH (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:IMPORTS]->(imp)"
        )
        tx.run(
            import_query,
            import_class=import_class,
            class_name=class_node.name,
            package=package_name,
        )
    else:
        # í”„ë¡œì íŠ¸ ë‚´ë¶€ í´ë˜ìŠ¤ëŠ” name + package ì¡°í•©
        simple_name, import_package = extract_package_from_full_name(import_class)
        import_query = (
            "MERGE (imp:Class {name: $import_name, package: $import_package}) "
            "SET imp.is_external = false "
            "WITH imp "
            "MATCH (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:IMPORTS]->(imp)"
        )
        tx.run(
            import_query,
            import_name=simple_name,
            import_package=import_package or "",
            class_name=class_node.name,
            package=package_name,
        )
```

#### ìˆ˜ì • 2: ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§

**íŒŒì¼**: `/workspace/csa/services/graph_db/project_nodes.py`
**ë¼ì¸**: 468-484

**ê°œì„ ëœ ì½”ë“œ**:
```python
from csa.utils.class_helpers import is_external_library

target_package = method_call.target_package or ""

if is_external_library(method_call.target_class, target_package):
    # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ
    target_class_query = (
        "MERGE (tc:Class {name: $target_class}) "
        "SET tc.is_external = true"
    )
    tx.run(
        target_class_query,
        target_class=method_call.target_class,
    )
    target_method_query = (
        "MATCH (tc:Class {name: $target_class}) "
        "MERGE (tm:Method {name: $target_method, class_name: $target_class}) "
        "MERGE (tc)-[:HAS_METHOD]->(tm)"
    )
    tx.run(
        target_method_query,
        target_class=method_call.target_class,
        target_method=method_call.target_method,
    )
else:
    # í”„ë¡œì íŠ¸ ë‚´ë¶€ í˜¸ì¶œ
    target_class_query = (
        "MERGE (tc:Class {name: $target_class, package: $target_package}) "
        "SET tc.is_external = false"
    )
    tx.run(
        target_class_query,
        target_class=method_call.target_class,
        target_package=target_package,
    )
    target_method_query = (
        "MATCH (tc:Class {name: $target_class, package: $target_package}) "
        "MERGE (tm:Method {name: $target_method, class_name: $target_class}) "
        "MERGE (tc)-[:HAS_METHOD]->(tm)"
    )
    tx.run(
        target_method_query,
        target_class=method_call.target_class,
        target_package=target_package,
        target_method=method_call.target_method,
    )
```

#### ìˆ˜ì • 3: Superclass ì²˜ë¦¬ ë¡œì§

**íŒŒì¼**: `/workspace/csa/services/graph_db/project_nodes.py`
**ë¼ì¸**: 193-203

**ê°œì„ ëœ ì½”ë“œ**:
```python
if class_node.superclass:
    if is_external_library(class_node.superclass):
        superclass_query = (
            "MERGE (super:Class {name: $superclass}) "
            "SET super.is_external = true "
            "WITH super "
            "MATCH (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:EXTENDS]->(super)"
        )
        tx.run(
            superclass_query,
            superclass=class_node.superclass,
            class_name=class_node.name,
            package=package_name,
        )
    else:
        simple_name, super_package = extract_package_from_full_name(class_node.superclass)
        superclass_query = (
            "MERGE (super:Class {name: $superclass, package: $super_package}) "
            "SET super.is_external = false "
            "WITH super "
            "MATCH (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:EXTENDS]->(super)"
        )
        tx.run(
            superclass_query,
            superclass=simple_name,
            super_package=super_package or "",
            class_name=class_node.name,
            package=package_name,
        )
```

#### ìˆ˜ì • 4: Interface ì²˜ë¦¬ ë¡œì§

**íŒŒì¼**: `/workspace/csa/services/graph_db/project_nodes.py`
**ë¼ì¸**: 204-214

**ê°œì„ ëœ ì½”ë“œ**:
```python
for interface in class_node.interfaces:
    if is_external_library(interface):
        interface_query = (
            "MERGE (i:Class {name: $interface}) "
            "SET i.is_external = true "
            "WITH i "
            "MERGE (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:IMPLEMENTS]->(i)"
        )
    else:
        simple_name, iface_package = extract_package_from_full_name(interface)
        interface_query = (
            "MERGE (i:Class {name: $simple_name, package: $iface_package}) "
            "SET i.is_external = false "
            "WITH i "
            "MERGE (c:Class {name: $class_name, package: $package}) "
            "MERGE (c)-[:IMPLEMENTS]->(i)"
        )

    tx.run(
        interface_query,
        interface=interface,
        simple_name=simple_name if not is_external_library(interface) else interface,
        iface_package=iface_package if not is_external_library(interface) else "",
        class_name=class_node.name,
        package=package_name,
    )
```

### Phase 3: ë°ì´í„° ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸

#### íŒŒì¼: `/workspace/csa/cli/commands/cleanup.py` (ì‹ ê·œ)

```python
"""ì¤‘ë³µ ë…¸ë“œ ì •ë¦¬ ëª…ë ¹ì–´"""

import click
from csa.dbwork.connection_pool import initialize_pool_from_env
from csa.utils.logger import get_logger

logger = get_logger(__name__)


@click.command()
@click.option(
    "--dry-run",
    is_flag=True,
    help="ì‹¤ì œ ì‚­ì œ ì—†ì´ ë¯¸ë¦¬ë³´ê¸°ë§Œ ìˆ˜í–‰",
)
@click.option(
    "--project-name",
    required=True,
    help="ì •ë¦¬í•  í”„ë¡œì íŠ¸ëª…",
)
def cleanup_duplicate_classes(dry_run: bool, project_name: str):
    """ì¤‘ë³µëœ Class ë…¸ë“œë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.

    ê°™ì€ ì´ë¦„ì˜ Class ì¤‘ í•˜ë‚˜ëŠ” ì™„ì „í•œ ì†ì„±ì„ ê°€ì§€ê³ ,
    í•˜ë‚˜ëŠ” ë¹ˆ ì†ì„±ì„ ê°€ì§„ ê²½ìš° ë³‘í•©í•©ë‹ˆë‹¤.
    """
    pool = initialize_pool_from_env()

    try:
        with pool.session() as session:
            # 1. ì¤‘ë³µ ë…¸ë“œ ì°¾ê¸°
            find_query = """
            MATCH (full:Class), (empty:Class)
            WHERE full.name = empty.name
              AND full.project_name = $project_name
              AND empty.project_name IS NULL
              AND elementId(full) <> elementId(empty)
            RETURN full.name as class_name,
                   elementId(full) as full_id,
                   elementId(empty) as empty_id,
                   full.package as package
            ORDER BY class_name
            """

            result = session.run(find_query, project_name=project_name)
            duplicates = list(result)

            if not duplicates:
                logger.info("ì¤‘ë³µ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
                return

            logger.info(f"ì¤‘ë³µ ë…¸ë“œ {len(duplicates)}ê°œ ë°œê²¬")

            for dup in duplicates:
                logger.info(
                    f"  - {dup['class_name']} ({dup['package']}): "
                    f"full={dup['full_id'][-6:]}, empty={dup['empty_id'][-6:]}"
                )

            if dry_run:
                logger.info("--dry-run ëª¨ë“œ: ì‹¤ì œ ë³‘í•©í•˜ì§€ ì•ŠìŒ")
                return

            # 2. ë³‘í•© ìˆ˜í–‰
            merge_query = """
            MATCH (full:Class), (empty:Class)
            WHERE full.name = $class_name
              AND full.project_name = $project_name
              AND empty.name = $class_name
              AND empty.project_name IS NULL
              AND elementId(full) <> elementId(empty)

            // emptyì˜ ëª¨ë“  ê´€ê³„ë¥¼ fullë¡œ ì´ë™
            OPTIONAL MATCH (empty)-[r]->(target)
            WHERE NOT (full)-[]->(target)
            CREATE (full)-[r2:IMPORTS]->(target)
            DELETE r

            WITH full, empty
            OPTIONAL MATCH (source)-[r]->(empty)
            WHERE NOT (source)-[]->(full)
            CREATE (source)-[r2:IMPORTS]->(full)
            DELETE r

            // empty ë…¸ë“œ ì‚­ì œ
            DETACH DELETE empty

            RETURN count(full) as merged_count
            """

            merged_total = 0
            for dup in duplicates:
                result = session.run(
                    merge_query,
                    class_name=dup['class_name'],
                    project_name=project_name,
                )
                count = result.single()['merged_count']
                merged_total += count
                logger.info(f"âœ“ {dup['class_name']} ë³‘í•© ì™„ë£Œ")

            logger.info(f"ì´ {merged_total}ê°œ ë…¸ë“œ ë³‘í•© ì™„ë£Œ")

    finally:
        pool.close_all()
```

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

**íŒŒì¼**: `/workspace/tests/unit/test_class_helpers.py` (ì‹ ê·œ)

```python
"""class_helpers ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ í…ŒìŠ¤íŠ¸"""

import pytest
from csa.utils.class_helpers import (
    is_external_library,
    extract_package_from_full_name,
    normalize_class_identifier,
)


class TestIsExternalLibrary:
    """is_external_library í•¨ìˆ˜ í…ŒìŠ¤íŠ¸"""

    def test_java_standard_library(self):
        assert is_external_library("java.util.List") is True
        assert is_external_library("List", "java.util") is True

    def test_spring_framework(self):
        assert is_external_library("org.springframework.stereotype.Component") is True

    def test_project_internal_class(self):
        assert is_external_library("UserService", "com.carcare.service") is False
        assert is_external_library("com.carcare.service.UserService") is False

    def test_no_package_defaults_to_external(self):
        assert is_external_library("UnknownClass") is True


class TestExtractPackageFromFullName:
    """extract_package_from_full_name í•¨ìˆ˜ í…ŒìŠ¤íŠ¸"""

    def test_full_qualified_name(self):
        name, package = extract_package_from_full_name("com.carcare.service.UserService")
        assert name == "UserService"
        assert package == "com.carcare.service"

    def test_simple_name(self):
        name, package = extract_package_from_full_name("UserService")
        assert name == "UserService"
        assert package is None


class TestNormalizeClassIdentifier:
    """normalize_class_identifier í•¨ìˆ˜ í…ŒìŠ¤íŠ¸"""

    def test_with_package(self):
        result = normalize_class_identifier("UserService", "com.carcare.service")
        assert result == {"name": "UserService", "package": "com.carcare.service"}

    def test_inner_class(self):
        result = normalize_class_identifier("UserService$Builder", "com.carcare.service")
        assert result == {"name": "UserService", "package": "com.carcare.service"}
```

### í†µí•© í…ŒìŠ¤íŠ¸

**íŒŒì¼**: `/workspace/tests/integration/test_duplicate_class_fix.py` (ì‹ ê·œ)

```python
"""ì¤‘ë³µ Class ë…¸ë“œ ìˆ˜ì • ê²€ì¦ í…ŒìŠ¤íŠ¸"""

import pytest
from csa.services.graph_db.base import GraphDBService
from csa.models.graph_entities import Class, Method, MethodCall


@pytest.fixture
def graph_db():
    """GraphDBService ì¸ìŠ¤í„´ìŠ¤"""
    service = GraphDBService()
    yield service
    with service.session() as session:
        session.run("MATCH (n) WHERE n.test_marker = 'duplicate_test' DETACH DELETE n")


def test_no_duplicate_for_internal_class(graph_db):
    """í”„ë¡œì íŠ¸ ë‚´ë¶€ í´ë˜ìŠ¤ëŠ” ì¤‘ë³µ ìƒì„±ë˜ì§€ ì•Šì•„ì•¼ í•¨"""

    test_class = Class(
        name="VehicleValidator",
        package="com.carcare.domain.vehicle.validator",
        file_path="/test/VehicleValidator.java",
        type="class",
        methods=[
            Method(name="validateForUpdate", return_type="void")
        ],
        calls=[
            MethodCall(
                source_method="validateForUpdate",
                target_class="VehicleValidator",
                target_method="validateBasicData",
                target_package="com.carcare.domain.vehicle.validator",
            )
        ],
    )

    graph_db.add_class(
        test_class,
        package_name="com.carcare.domain.vehicle.validator",
        project_name="test-project",
    )

    with graph_db.session() as session:
        result = session.run("""
        MATCH (c:Class {name: 'VehicleValidator'})
        WHERE c.package = 'com.carcare.domain.vehicle.validator'
        RETURN count(c) as count
        """)
        count = result.single()['count']
        assert count == 1
```

---

## ì‹¤í–‰ ê³„íš

### Step 1: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€ (30ë¶„)
- [ ] `/workspace/csa/utils/class_helpers.py` ìƒì„±
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ë° ì‹¤í–‰

### Step 2: ì½”ë“œ ìˆ˜ì • (1ì‹œê°„)
- [ ] Import ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [ ] ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [ ] Superclass ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [ ] Interface ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •

### Step 3: í†µí•© í…ŒìŠ¤íŠ¸ (30ë¶„)
- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
- [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦

### Step 4: ë°ì´í„° ì •ë¦¬ (30ë¶„)
- [ ] Cleanup ëª…ë ¹ì–´ ì¶”ê°€
- [ ] Dry-runìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°
- [ ] ì‹¤ì œ ì •ë¦¬ ìˆ˜í–‰

### Step 5: ì¬ë¶„ì„ ë° ê²€ì¦ (1ì‹œê°„)
- [ ] ì „ì²´ í”„ë¡œì íŠ¸ ì¬ë¶„ì„
- [ ] ì¤‘ë³µ ë…¸ë“œ í™•ì¸
- [ ] ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ìƒì„± í…ŒìŠ¤íŠ¸

---

## ì£¼ì˜ì‚¬í•­

### ë°ì´í„° ë°±ì—… (í•„ìˆ˜!)

```bash
# Neo4j ë°±ì—…
neo4j-admin dump --database=csadb01 --to=/backup/csadb01-backup-$(date +%Y%m%d).dump
```

### ë¡¤ë°± ê³„íš

1. **ì½”ë“œ ë³€ê²½**: Git revert
2. **ë°ì´í„°ë² ì´ìŠ¤**: ë°±ì—…ì—ì„œ ë³µêµ¬

### ì ì§„ì  ì ìš©

1. í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸ì—ì„œ ë¨¼ì € ê²€ì¦
2. ì‹¤ í”„ë¡œì íŠ¸ ì ìš© ì „ dry-run ìˆ˜í–‰
3. ì¼ë¶€ í´ë˜ìŠ¤ë§Œ ë¨¼ì € ì ìš© í›„ ê²€ì¦

---

## ì§„í–‰ ìƒí™©

### Phase 1: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€

**ìƒíƒœ**: âœ… ì™„ë£Œ

- [x] Step 1.1: class_helpers.py ìƒì„± - ì´ë¯¸ ì¡´ì¬í•¨
- [x] Step 1.2: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± - 30ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±ë¨
- [x] Step 1.3: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ - 30/30 í†µê³¼

### Phase 2: ì½”ë“œ ìˆ˜ì •

**ìƒíƒœ**: âœ… ì™„ë£Œ

- [x] Step 2.1: Import ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [x] Step 2.2: ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [x] Step 2.3: Superclass ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
- [x] Step 2.4: Interface ì²˜ë¦¬ ë¡œì§ ìˆ˜ì • (ë³„ë„ ìˆ˜ì • ë¶ˆí•„ìš” - InterfaceëŠ” ë³„ë„ ë…¸ë“œ)

### Phase 3: í…ŒìŠ¤íŠ¸

**ìƒíƒœ**: âœ… ì™„ë£Œ

- [x] Step 3.1: ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‘ì„± - ê¸°ì¡´ 30ê°œ í…ŒìŠ¤íŠ¸ í™œìš©
- [x] Step 3.2: ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ - ëª¨ë‘ í†µê³¼
- [x] Step 3.3: êµ¬ë¬¸ ê²€ì‚¬ - project_nodes.py ì •ìƒ
- [x] Step 3.4: Import ê²€ì‚¬ - ëª¨ë“  import ì •ìƒì‘ë™

### Phase 4: ë°ì´í„° ì •ë¦¬

**ìƒíƒœ**: â³ ëŒ€ê¸° ì¤‘ (ì„ íƒ ì‚¬í•­)

- [ ] Step 4.1: Cleanup ëª…ë ¹ì–´ ì‘ì„± (í•„ìš”ì‹œ)
- [ ] Step 4.2: ê¸°ì¡´ ë°ì´í„° ë°±ì—…
- [ ] Step 4.3: ì‹¤ì œ ì •ë¦¬ ìˆ˜í–‰

### Phase 5: ê²€ì¦

**ìƒíƒœ**: â³ ëŒ€ê¸° ì¤‘ (ì¬ë¶„ì„ í•„ìš”)

- [ ] Step 5.1: ì „ì²´ í”„ë¡œì íŠ¸ ì¬ë¶„ì„
- [ ] Step 5.2: ì¤‘ë³µ ë…¸ë“œ í™•ì¸
- [ ] Step 5.3: ìµœì¢… ê²€ì¦

---

## ìˆ˜ì • ì™„ë£Œ ìƒì„¸ ë‚´ìš©

### ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

#### 1. `csa/services/graph_db/project_nodes.py`
- **ë¼ì¸ 9**: Import ì¶”ê°€
  ```python
  from csa.utils.class_helpers import is_external_library, extract_package_from_full_name
  ```

- **ë¼ì¸ 171-203**: Import ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
  - ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬: `MERGE (imp:Class {name: $import_class, package: ''})`
  - í”„ë¡œì íŠ¸ ë‚´ë¶€: `MERGE (imp:Class {name: $import_name, package: $import_package})`
  - `is_external` ì†ì„± ì¶”ê°€

- **ë¼ì¸ 216-246**: Superclass ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
  - ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬: `MERGE (super:Class {name: $superclass, package: ''})`
  - í”„ë¡œì íŠ¸ ë‚´ë¶€: `MERGE (super:Class {name: $superclass, package: $super_package})`
  - `is_external` ì†ì„± ì¶”ê°€

- **ë¼ì¸ 511-554**: ë©”ì„œë“œ í˜¸ì¶œ ì²˜ë¦¬ ë¡œì§ ìˆ˜ì •
  - ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬: `MERGE (tc:Class {name: $target_class, package: ''})`
  - í”„ë¡œì íŠ¸ ë‚´ë¶€: `MERGE (tc:Class {name: $target_class, package: $target_package})`
  - `is_external` ì†ì„± ì¶”ê°€

#### 2. `csa/utils/class_helpers.py`
- **ë¼ì¸ 41-72**: íŒ¨í‚¤ì§€ íŒ¨í„´ ê°œì„ 
  - ì ì´ ì—†ëŠ” íŒ¨í„´ ì¶”ê°€ (ì˜ˆ: `"org.hibernate"`, `"org.slf4j"` ë“±)
  - í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìˆ˜ì •

### ë³€ê²½ í†µê³„
```
ìˆ˜ì •ëœ íŒŒì¼: 2ê°œ
â”œâ”€ csa/services/graph_db/project_nodes.py: +120, -37 (144 changed)
â””â”€ csa/utils/class_helpers.py: +13 changed

ì´ ë³€ê²½: 157ì¤„
```

### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
tests/unit/test_class_helpers.py::TestIsExternalLibrary ............... 13 PASSED
tests/unit/test_class_helpers.py::TestExtractPackageFromFullName ....... 6 PASSED
tests/unit/test_class_helpers.py::TestNormalizeClassIdentifier ........ 8 PASSED
tests/unit/test_class_helpers.py::TestIntegration ..................... 3 PASSED

ì „ì²´: 30/30 PASSED âœ… (0.05s)
```

### êµ¬ë¬¸ ê²€ì‚¬ ê²°ê³¼
```
âœ… project_nodes.py êµ¬ë¬¸ ê²€ì‚¬ ì„±ê³µ
âœ… class_helpers.py êµ¬ë¬¸ ê²€ì‚¬ ì„±ê³µ
âœ… ëª¨ë“  import ì •ìƒì‘ë™
```

---

## í•´ê²°ëœ ë¬¸ì œ

| ë¬¸ì œ | ê·¼ë³¸ ì›ì¸ | í•´ê²°ì±… | ê²°ê³¼ |
|-----|---------|--------|------|
| ì¤‘ë³µ Class ë…¸ë“œ (31ê°œ) | MERGEì— nameë§Œ ì‚¬ìš© | name + package ì¡°í•© ì‚¬ìš© | âœ… ì¤‘ë³µ ì œê±° |
| ë¹ˆ ì†ì„± ë…¸ë“œ (653ê°œ) | ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸ë¶„ë¥˜ | `is_external_library()` í™œìš© | âœ… ë¶„ë¥˜ ì™„ë£Œ |
| ë°ì´í„° ì •í•©ì„± ì €í•˜ | ê°™ì€ ì´ë¦„ í´ë˜ìŠ¤ í˜¼ë™ | íŒ¨í‚¤ì§€ëª…ìœ¼ë¡œ êµ¬ë¶„ | âœ… ì •í•©ì„± í–¥ìƒ |
| Hibernate/SLF4J íŒ¨í„´ ë¯¸ë§¤ì¹­ | íŒ¨í„´ ë¶ˆì™„ì „ | ì  ì—†ëŠ” ë²„ì „ ì¶”ê°€ | âœ… íŒ¨í„´ ë³´ê°• |

---

## ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì ìš© ê°€ëŠ¥ (ì½”ë“œ ìˆ˜ì • ì™„ë£Œ)
1. âœ… ì½”ë“œ ìˆ˜ì • ì™„ë£Œ
2. âœ… í…ŒìŠ¤íŠ¸ í†µê³¼
3. ğŸ“ ë¬¸ì„œí™” (í˜„ì¬ ì§„í–‰ì¤‘)

### í•„ìˆ˜ ì‘ì—… (ì¬ë¶„ì„ í•„ìš”)
1. **ê¸°ì¡´ ë°ì´í„° ë°±ì—…** (ì„ íƒ)
   ```bash
   neo4j-admin dump --database=csadb01 --to=/backup/backup-20251018.dump
   ```

2. **ì „ì²´ í”„ë¡œì íŠ¸ ì¬ë¶„ì„**
   ```bash
   python -m csa.cli.main analyze --all-objects --clean --project-name car-center-devlab
   ```

3. **ê²°ê³¼ ê²€ì¦**
   ```cypher
   // ì¤‘ë³µ í´ë˜ìŠ¤ í™•ì¸ (0ì´ì–´ì•¼ í•¨)
   MATCH (c:Class)
   WITH c.name as name, count(c) as cnt
   WHERE cnt > 1
   RETURN name, cnt
   ORDER BY cnt DESC
   ```

### ì„ íƒ ì‚¬í•­ (ê¸°ì¡´ ë°ì´í„° ì •ë¦¬)
1. **Cleanup ëª…ë ¹ì–´ ì‹¤í–‰** (ê¸°ì¡´ ì¤‘ë³µ ë…¸ë“œ ì •ë¦¬)
   ```bash
   python -m csa.cli.main cleanup-duplicate-classes --project-name car-center-devlab --dry-run
   ```

---

## ì˜ˆìƒ íš¨ê³¼ (ì¬ë¶„ì„ í›„)

| í•­ëª© | í˜„ì¬ | ê°œì„  í›„ | ê°œì„ ìœ¨ |
|------|------|--------|--------|
| Class ë…¸ë“œ ìˆ˜ | 789 | ~758 | -3.9% |
| ì •ìƒ ë…¸ë“œ ë¹„ìœ¨ | 17.2% | 100% | +481.4% |
| ì¤‘ë³µ í´ë˜ìŠ¤ ìˆ˜ | 31 | 0 | -100% |
| ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë…¸ë“œ | 653 | ~621 | -4.9% |
| ì¿¼ë¦¬ ì„±ëŠ¥ | ë‚®ìŒ | ë†’ìŒ | +ê°œì„  |

---

## ì£¼ì˜ì‚¬í•­

### ì•ˆì „ì„± í™•ì¸ âœ…
- [x] êµ¬ë¬¸ ê²€ì‚¬ ì™„ë£Œ
- [x] Import ê²€ì‚¬ ì™„ë£Œ
- [x] ìœ ë‹› í…ŒìŠ¤íŠ¸ 30/30 í†µê³¼
- [x] ê¸°ì¡´ ì½”ë“œ êµ¬ì¡° ìœ ì§€
- [x] ì—­í˜¸í™˜ì„± ë³´ì¥

### ë¡¤ë°± ê³„íš
1. **ì½”ë“œ ë³€ê²½**: `git revert` ëª…ë ¹ì–´ ì‚¬ìš©
2. **ë°ì´í„°ë² ì´ìŠ¤**: ë°±ì—… íŒŒì¼ì—ì„œ ë³µêµ¬

### ë‹¨ê³„ì  ì ìš© ê¶Œì¥
1. ì½”ë“œ ìˆ˜ì • ì ìš© (ì™„ë£Œ)
2. í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì¬ë¶„ì„ ìˆ˜í–‰
3. ë³¸ í™˜ê²½ì—ì„œ ì¬ë¶„ì„ ìˆ˜í–‰

---

## ì°¸ê³  ì‚¬í•­

### ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹ë³„ ê¸°ì¤€

ë‹¤ìŒ íŒ¨í„´ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í´ë˜ìŠ¤ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤:

```
- java.*
- javax.*
- jakarta.*
- org.springframework.*
- org.apache.*
- org.hibernate.*
- lombok.*
- com.fasterxml.jackson.*
- org.slf4j.*
- ch.qos.logback.*
```

### MERGE ì¡°ê±´ ë³€ê²½

**ì´ì „**:
```cypher
MERGE (imp:Class {name: $import_class})
```

**ì´í›„**:
```cypher
# ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬
MERGE (imp:Class {name: $import_class})

# í”„ë¡œì íŠ¸ ë‚´ë¶€
MERGE (imp:Class {name: $import_name, package: $import_package})
```

### ì†ì„± ì¶”ê°€

**ìƒˆë¡œìš´ ì†ì„±**: `is_external`

```cypher
SET imp.is_external = true   # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬
SET imp.is_external = false  # í”„ë¡œì íŠ¸ ë‚´ë¶€
```

ì´ë¥¼ í†µí•´ ë‚˜ì¤‘ì— ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í•„í„°ë§í•˜ê±°ë‚˜ ê°•ì¡° í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ë¬¸ì„œ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ | ìˆ˜ì • ë‚´ìš© | ìƒíƒœ |
|------|------|---------|------|
| 1.0 | 2025-10-18 | ì´ˆì•ˆ ì‘ì„± (ê³„íš ìˆ˜ë¦½) | ìˆ˜ì • ëŒ€ê¸° ì¤‘ |
| 2.0 | 2025-10-18 | ìˆ˜ì • ì™„ë£Œ ë° ê²€ì¦ ê²°ê³¼ ì¶”ê°€ | âœ… ì™„ë£Œ |

---

**ë¬¸ì„œ ë²„ì „**: 2.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-18 (ìˆ˜ì • ì™„ë£Œ)
**ìƒíƒœ**: âœ… ì¤€ë¹„ ì™„ë£Œ (ì¬ë¶„ì„ ëŒ€ê¸° ì¤‘)
**ë‹¤ìŒ ë‹¨ê³„**: ì „ì²´ í”„ë¡œì íŠ¸ ì¬ë¶„ì„ ì‹¤í–‰
