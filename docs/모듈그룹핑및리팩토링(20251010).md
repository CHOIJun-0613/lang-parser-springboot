# csa/services 모듈 그룹핑 및 리팩토링 계획

**작성일**: 2025년 10월 10일  
**목적**: csa/services 하위 소스코드를 작업 유형별로 모듈 그룹핑하여 코드 구조 개선

## 1. 현재 상황 분석

### 1.1 현재 파일 구조
```
csa/services/
├── java_parser.py                    (~39,815 tokens - 매우 큰 파일)
├── sql_parser.py                     (SQL 분석)
├── db_call_analysis.py               (DB 호출 관계 분석)
├── db_parser.py                      (DDL 파일 파싱)
├── graph_db.py                       (Neo4j DB CRUD 관리)
├── java_parser_addon_r001.py         (논리명 추출)
├── sequence_diagram_generator.py     (Facade)
├── plantuml_diagram_generator.py     (PlantUML 다이어그램)
├── mermaid_diagram_generator.py      (Mermaid 다이어그램)
└── neo4j_connection_pool.py         (Connection Pool)
```

### 1.2 제안된 그룹핑 구조
```
csa/services/
├── common/                           # 공통 기능 코드
│   └── sql_parser.py
├── analyze/                          # java object, db object 분석 관련 코드
│   ├── java_parser.py
│   ├── java_parser_addon_r001.py
│   ├── db_parser.py
│   └── db_call_analysis.py
├── sequence/                         # sequence diagram 생성 관련 코드
│   ├── sequence_diagram_generator.py
│   ├── plantuml_diagram_generator.py
│   └── mermaid_diagram_generator.py
├── crud/                             # CRUD-Matrix 생성 코드
│   └── (db_call_analysis.py에서 분리)
├── dbservice/                        # Neo4J Database 쿼리 코드
│   └── graph_db.py
└── graphdb/                          # Neo4J Database Connection Pool관리
    └── neo4j_connection_pool.py
```

## 2. 가능성 및 작업 난이도 분석

### 2.1 가능성 평가
**가능성: 높음 ✅**

제안하신 그룹핑 구조는 논리적으로 타당하며, 코드 가독성과 유지보수성을 크게 향상시킬 수 있습니다.

### 2.2 난이도별 작업 그룹 분류

#### 🟢 난이도 낮음 (Low) - 독립적이고 의존성 적음
1. **graphdb 폴더 생성**
   - `neo4j_connection_pool.py` 이동
   - `graph_db.py`는 현재 위치 유지 (다른 모듈에서 많이 참조)

#### 🟡 난이도 중간 (Medium) - 약간의 import 수정 필요
2. **sequence 폴더 생성**
   - `sequence_diagram_generator.py` 이동
   - `plantuml_diagram_generator.py` 이동
   - `mermaid_diagram_generator.py` 이동
   - 3개 파일만 있고 서로 연관성 높음

3. **common 폴더 생성**
   - `sql_parser.py` 이동 (공통 유틸리티)

#### 🔴 난이도 높음 (High) - 많은 import 수정 및 테스트 필요
4. **analyze 폴더 생성**
   - `java_parser.py` 이동 (매우 큰 파일, 많은 곳에서 import)
   - `java_parser_addon_r001.py` 이동
   - `db_parser.py` 이동

5. **dbservice 폴더 생성**
   - `db_call_analysis.py` 이동
   - 기존 `graph_db.py`는 그대로 두거나 별도 처리

6. **crud 폴더 생성**
   - CRUD Matrix 생성 코드는 현재 `db_call_analysis.py`에 포함되어 있음
   - 별도 분리 필요 시 추가 작업

## 3. 단계적 리팩토링 계획 (권장 순서)

### 3.1 1단계: 독립적 모듈 분리 (난이도 낮음)
**목표**: graphdb 폴더 생성 및 Connection Pool 모듈 분리

**작업 내용**:
- `csa/services/graphdb/` 폴더 생성
- `neo4j_connection_pool.py` 이동
- `__init__.py` 파일 생성
- import 수정: `csa.services.neo4j_connection_pool` → `csa.services.graphdb.neo4j_connection_pool`

**영향받는 파일**:
- `csa/services/graph_db.py`
- `csa/cli/main.py`

### 3.2 2단계: Sequence Diagram 모듈 분리 (난이도 중간)
**목표**: sequence 폴더 생성 및 다이어그램 생성 모듈들 분리

**작업 내용**:
- `csa/services/sequence/` 폴더 생성
- `sequence_diagram_generator.py` 이동
- `plantuml_diagram_generator.py` 이동
- `mermaid_diagram_generator.py` 이동
- `__init__.py` 파일 생성

**영향받는 파일**:
- `csa/cli/main.py`

### 3.3 3단계: 공통 모듈 분리 (난이도 중간)
**목표**: common 폴더 생성 및 공통 유틸리티 모듈 분리

**작업 내용**:
- `csa/services/common/` 폴더 생성
- `sql_parser.py` 이동
- `__init__.py` 파일 생성

**영향받는 파일**:
- `csa/services/java_parser.py`
- `csa/services/db_call_analysis.py`

### 3.4 4단계: 분석 모듈 분리 (난이도 높음)
**목표**: analyze 폴더 생성 및 분석 관련 모듈들 분리

**작업 내용**:
- `csa/services/analyze/` 폴더 생성
- `java_parser.py` 이동 (매우 큰 파일)
- `java_parser_addon_r001.py` 이동
- `db_parser.py` 이동
- `__init__.py` 파일 생성

**영향받는 파일**:
- `csa/cli/main.py` (많은 import 수정 필요)
- `tests/` 폴더의 테스트 파일들

### 3.5 5단계: DB 서비스 모듈 분리 (난이도 높음)
**목표**: dbservice 폴더 생성 및 DB 관련 서비스 모듈 분리

**작업 내용**:
- `csa/services/dbservice/` 폴더 생성
- `db_call_analysis.py` 이동
- `graph_db.py` 이동 또는 현재 위치 유지 검토
- `__init__.py` 파일 생성

**영향받는 파일**:
- `csa/cli/main.py`
- 모든 서비스 모듈들

### 3.6 6단계: CRUD 모듈 분리 (선택사항)
**목표**: crud 폴더 생성 및 CRUD Matrix 생성 기능 분리

**작업 내용**:
- `csa/services/crud/` 폴더 생성
- `db_call_analysis.py`에서 CRUD Matrix 관련 코드 분리
- 별도 모듈로 생성

## 4. 주의사항 및 고려사항

### 4.1 중요 고려사항

1. **import 경로 변경 영향도**
   - `csa/cli/main.py`에서 많은 서비스를 import하고 있음
   - 모든 import 문 수정 필요

2. **`java_parser.py` 파일 크기**
   - 현재 ~39,815 tokens로 매우 큼
   - 단순 이동보다 파일 자체를 여러 개로 분할하는 것도 고려 필요

3. **CRUD Matrix 기능**
   - 현재 `db_call_analysis.py`에 포함
   - 별도 crud 폴더로 분리 시 추가 작업 필요

4. **`graph_db.py` 처리**
   - 현재 많은 곳에서 참조하는 핵심 모듈
   - graphdb 폴더로 이동 vs 현재 위치 유지 고려 필요

5. **테스트 영향**
   - tests 폴더의 테스트 코드도 모두 수정 필요

### 4.2 추가 개선사항

1. **`java_parser.py` 파일 분할**
   - 현재 매우 큰 파일을 기능별로 분할
   - 별도 작업으로 진행 고려

2. **`__init__.py` 파일 생성**
   - 각 폴더에 `__init__.py` 파일 생성
   - import 편의성 제공

3. **의존성 관리**
   - 각 모듈 간 의존성 최소화
   - 순환 참조 방지

## 5. 최종 권장사항

### 5.1 추천 접근법

✅ **단계적 진행 (Phase-by-Phase)**
- 한 번에 모든 걸 바꾸지 말고 단계적으로 진행
- 각 단계마다 테스트 실행 및 검증

✅ **우선순위**
1. graphdb (가장 독립적)
2. sequence (Facade 패턴으로 이미 잘 분리됨)
3. common (유틸리티성 모듈)
4. analyze (큰 파일, 신중하게)
5. dbservice (복잡한 의존성)

### 5.2 실행 전 체크리스트

- [ ] 각 단계별 백업 생성
- [ ] 테스트 코드 준비
- [ ] import 경로 변경 스크립트 준비
- [ ] 단계별 검증 계획 수립

### 5.3 예상 효과

1. **코드 가독성 향상**
   - 관련 기능들이 논리적으로 그룹핑됨
   - 파일 탐색 및 이해 용이

2. **유지보수성 향상**
   - 기능별 모듈 분리로 수정 범위 명확화
   - 의존성 관리 개선

3. **확장성 향상**
   - 새로운 기능 추가 시 적절한 위치 명확
   - 모듈별 독립적 개발 가능

## 6. 결론

계획하신 리팩토링은 충분히 실행 가능하며, 코드 품질 향상에 크게 도움이 될 것입니다. 

다만 **영향도가 큰 작업이므로 단계적으로 신중하게 진행**하시는 것을 권장드립니다.

각 단계별로 충분한 테스트와 검증을 거쳐 진행하시면 안전하고 효과적인 리팩토링이 가능할 것입니다.
