# Pydantic 필드명 충돌 수정 작업

**작성일**: 2025-10-20
**작업자**: Claude Code
**우선순위**: 🔴 High
**예상 시간**: 30분

---

## 📋 작업 개요

`TableUsageSpec` 모델의 `schema` 필드가 Pydantic `BaseModel`의 `schema()` 메서드와 충돌하여 경고가 발생하는 문제를 해결합니다.

---

## 🐛 문제 상황

### 경고 메시지
```
UserWarning: Field name "schema" in "TableUsageSpec" shadows an attribute in parent "BaseModel"
```

### 문제 코드
```python
# csa/models/class_spec.py:78-83
class TableUsageSpec(BaseModel):
    """테이블 사용 명세 정보"""
    table_name: str
    schema: str = "public"  # ← 문제!
    operations: List[str] = []
    description: str = ""
```

### 원인
- Pydantic v2의 `BaseModel`은 `schema()` 메서드를 가지고 있음
- 필드명 `schema`가 이 메서드를 가림 (shadowing)
- 런타임 오류는 없지만 경고 발생 및 코드 명확성 저해

---

## 🔧 해결 방안

### 필드명 변경
```python
schema: str = "public"  # Before
db_schema: str = "public"  # After
```

### 영향 범위
1. `csa/models/class_spec.py` - 모델 정의
2. `csa/services/class_spec/repository.py` - CRUD 정보 조회
3. `csa/services/class_spec/template.py` - 템플릿 렌더링

---

## 📝 수정 계획

### Step 1: 모델 수정
**파일**: `csa/models/class_spec.py:78-83`

**Before**:
```python
class TableUsageSpec(BaseModel):
    """테이블 사용 명세 정보"""
    table_name: str
    schema: str = "public"
    operations: List[str] = []
    description: str = ""
```

**After**:
```python
class TableUsageSpec(BaseModel):
    """테이블 사용 명세 정보"""
    table_name: str
    db_schema: str = "public"  # schema → db_schema
    operations: List[str] = []
    description: str = ""
```

---

### Step 2: Repository 수정
**파일**: `csa/services/class_spec/repository.py:360-380`

**Before**:
```python
key = f"{schema}.{table_name}"
if key not in table_operations:
    table_operations[key] = {
        "table_name": table_name,
        "schema": schema,  # ← 수정 필요
        "operations": set()
    }
```

**After**:
```python
key = f"{schema}.{table_name}"
if key not in table_operations:
    table_operations[key] = {
        "table_name": table_name,
        "db_schema": schema,  # schema → db_schema
        "operations": set()
    }
```

**수정 위치**:
- Line ~373: 딕셔너리 키 변경

---

### Step 3: Template 수정
**파일**: `csa/services/class_spec/template.py:265-280`

**Before**:
```python
def _render_database_info(self, table_usage: List[TableUsageSpec]) -> str:
    """데이터베이스 연관 정보 렌더링"""
    # ...
    for idx, table in enumerate(table_usage, 1):
        operations_str = "/".join(sorted(table.operations)) if table.operations else "-"
        lines.append(
            f"| {idx} | {table.table_name} | {table.schema} | "  # ← 수정 필요
            f"{operations_str} | {table.description or '-'} |"
        )
```

**After**:
```python
def _render_database_info(self, table_usage: List[TableUsageSpec]) -> str:
    """데이터베이스 연관 정보 렌더링"""
    # ...
    for idx, table in enumerate(table_usage, 1):
        operations_str = "/".join(sorted(table.operations)) if table.operations else "-"
        lines.append(
            f"| {idx} | {table.table_name} | {table.db_schema} | "  # schema → db_schema
            f"{operations_str} | {table.description or '-'} |"
        )
```

**수정 위치**:
- Line ~276: 템플릿 렌더링 시 필드명 변경

---

## ✅ 테스트 계획

### 1. 경고 메시지 확인
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NotificationRepository
```

**기대 결과**:
- ❌ Before: `UserWarning: Field name "schema" in "TableUsageSpec" shadows an attribute in parent "BaseModel"`
- ✅ After: 경고 메시지 없음

### 2. 생성된 명세서 확인
```bash
# 생성된 파일 확인
cat output/class-spec/.../CLASS_SPEC_NotificationRepository_*.md | grep "스키마"
```

**기대 결과**:
```markdown
| No | 테이블명 | 스키마 | CRUD 작업 | 설명 |
|----|----------|--------|-----------|------|
| 1 | notifications | public | C/D/R/U | - |
```

### 3. Python 검증
```python
from csa.models.class_spec import TableUsageSpec

# 모델 생성 테스트
table = TableUsageSpec(
    table_name="users",
    db_schema="public",
    operations=["C", "R", "U", "D"]
)

assert table.db_schema == "public"
assert table.table_name == "users"
print("✓ 모델 생성 성공")
```

---

## 📊 체크리스트

- [ ] Step 1: `models/class_spec.py` 수정
- [ ] Step 2: `repository.py` 수정
- [ ] Step 3: `template.py` 수정
- [ ] 테스트 1: 경고 메시지 확인
- [ ] 테스트 2: 생성된 명세서 확인
- [ ] 테스트 3: Python 모델 검증
- [ ] Git commit

---

## 🎯 완료 기준

1. ✅ 경고 메시지 사라짐
2. ✅ 기존 기능 정상 작동 (명세서 생성)
3. ✅ 테이블 스키마 정보 정상 표시

---

## 📝 작업 로그

### 시작 시간
- 2025-10-20 20:45:00

### 종료 시간
- (작업 완료 후 기록)

### 실제 소요 시간
- (작업 완료 후 기록)

### 이슈/특이사항
- (작업 중 발견된 이슈 기록)
