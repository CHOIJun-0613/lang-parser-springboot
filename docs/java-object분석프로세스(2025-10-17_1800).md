# Java 객체 분석 및 DB 저장 전체 프로세스

작성일: 2025-10-17 18:00

## 1단계: CLI 명령 진입

**파일**: `csa/cli/commands/analyze.py:33-110`

```bash
python -m csa.cli.main analyze --all-objects --project-name myproject
```

- CLI 옵션 파싱 (`--java-object`, `--db-object`, `--all-objects` 등)
- 환경변수 로딩 (`.env` 파일에서 소스 폴더, Neo4j 연결 정보 등)
- `analyze_project()` 호출

---

## 2단계: 분석 오케스트레이션

**파일**: `csa/services/analysis/handlers.py:68-155`

### 2.1 DB 연결 및 초기화
```python
db = _prepare_database(...)  # handlers.py:95-106
```

- Neo4j 연결 (URI, User, Password, Database)
- `--clean` 옵션이 있으면 기존 데이터 삭제:
  - `db.clean_java_objects()`: Package, Class, Method, Field, Bean, Endpoint 등 삭제
  - `db.clean_db_objects()`: Database, Table, Column 등 삭제

### 2.2 **DB 분석 먼저 수행** (2025-10-17 변경됨)
```python
if all_objects or db_object:  # handlers.py:109-118
    db_stats = analyze_full_project_db(...)
```

- DDL 파일 파싱 → Table/Column 노드 Neo4j 저장
- 목적: Java 코드 분석 시 테이블 참조 관계를 정확하게 연결

### 2.3 **Java 분석 나중에 수행**
```python
if all_objects or java_object:  # handlers.py:121-131
    artifacts, final_project_name = analyze_full_project_java(...)
    java_stats = save_java_objects_to_neo4j(...)
```

---

## 3단계: Java 프로젝트 파싱

**파일**: `csa/services/analysis/java_pipeline.py:13-58`

### 3.1 프로젝트 분석 시작
```python
analyze_full_project_java(java_source_folder, project_name, logger)
```

호출 → `parse_java_project_full(directory)`

**파일**: `csa/services/java_analysis/project.py:336-750`

---

## 4단계: 실제 Java 파싱 (핵심 로직)

### 4.1 프로젝트명 추출
```python
project_name = extract_project_name(directory)  # project.py:340
```

- 폴더명에서 프로젝트명 추출

### 4.2 전체 클래스 개수 계산
```python
# project.py:357-372
for root, _, files in os.walk(directory):
    for file in files:
        if file.endswith(".java"):
            # 파싱하여 클래스 개수 세기
            total_classes += 1
```

- 진행 상황 표시를 위한 사전 계산

### 4.3 Java 파일 순회 및 파싱
```python
# project.py:375-707
for root, _, files in os.walk(directory):
    for file in files:
        if file.endswith(".java"):
```

#### 4.3.1 파일 읽기 및 AST 파싱
```python
tree = javalang.parse.parse(file_content)  # project.py:386
```

- `javalang` 라이브러리로 Java 소스를 AST(Abstract Syntax Tree)로 변환

#### 4.3.2 Package 정보 추출
```python
package_name = tree.package.name  # project.py:387
packages[package_name] = Package(name=package_name)
```

#### 4.3.3 Import 매핑
```python
import_map = {}
for imp in tree.imports:
    class_name = imp.path.split('.')[-1]
    import_map[class_name] = imp.path  # project.py:402-404
```

#### 4.3.4 Class/Interface 처리
```python
for type_decl in tree.types:
    if isinstance(type_decl, (ClassDeclaration, InterfaceDeclaration)):
        # project.py:411-455
```

**추출 정보**:
- 클래스명, 타입 (class/interface)
- 어노테이션 파싱 (`@Service`, `@Controller`, `@Entity` 등)
- **논리명 추출** (`extract_java_class_logical_name()`) - Rule001
- **설명 추출** (`extract_java_class_description()`) - Rule002
- sub_type 분류 (controller, service, repository 등)

```python
class_node = Class(
    name=class_name,
    logical_name=class_logical_name,
    file_path=file_path,
    type=class_type,
    sub_type=sub_type,
    source=file_content,
    annotations=class_annotations,
    package_name=package_name,
    project_name=project_name,
    description=class_description,
    ...
)
```

#### 4.3.5 상속/구현 관계 처리
```python
# 상속 (extends)
if class_declaration.extends:
    classes[class_key].superclass = ...  # project.py:460-465

# 인터페이스 구현 (implements)
if class_declaration.implements:
    classes[class_key].interfaces.append(...)  # project.py:467-473
```

#### 4.3.6 Field(필드) 처리
```python
for field_declaration in class_declaration.fields:
    for declarator in field_declaration.declarators:
        # project.py:476-507
        prop = Field(
            name=declarator.name,
            logical_name=field_logical_name,  # Rule001
            type=field_declaration.type.name,
            modifiers=list(field_declaration.modifiers),
            annotations=field_annotations,
            initial_value=initial_value,
            ...
        )
```

#### 4.3.7 Method(메서드) 처리
```python
all_declarations = class_declaration.methods + class_declaration.constructors
for declaration in all_declarations:
    # project.py:511-582
```

**추출 정보**:
- 메서드명, 반환 타입, 파라미터
- Modifiers (public, private, static 등)
- 어노테이션 (`@GetMapping`, `@Transactional` 등)
- **논리명 추출** - Rule001
- **설명 추출** - Rule002
- **메서드 소스 코드** (중괄호 매칭으로 추출)

#### 4.3.8 메서드 호출 관계 분석 (CALLS)
```python
# project.py:584-691
for _, invocation in declaration.filter(javalang.tree.MethodInvocation):
```

**처리 로직**:
1. **로그 메서드 제외**: `log.info()`, `logger.debug()`, `System.out.println()` 등
2. **Stream API 제외**: `map()`, `filter()`, `collect()` 등
3. **타겟 클래스 추론**:
   - 로컬 변수 타입 매핑 (`local_var_map`)
   - Import 문 참조
   - 패키지 기반 추론 (controller → service 추론)

```python
call = MethodCall(
    source_package=package_name,
    source_class=class_name,
    source_method=declaration.name,
    target_package=resolved_target_package,
    target_class=resolved_target_class_name,
    target_method=invocation.member,
    call_order=call_order,
    line_number=line_number,
)
classes[class_key].calls.append(call)
```

#### 4.3.9 Lombok 메서드 생성
```python
has_data_annotation = any(ann.name == "Data" for ann in class_annotations)
if has_data_annotation:
    lombok_methods = generate_lombok_methods(...)
    classes[class_key].methods.extend(lombok_methods)  # project.py:693-698
```

- `@Data` 어노테이션이 있으면 getter/setter 자동 생성

---

### 4.4 Spring Boot 특화 분석

파싱된 클래스 리스트로부터 Spring Boot 객체 추출:

```python
# project.py:709-723
classes_list = list(classes.values())
beans = extract_beans_from_classes(classes_list)  # @Service, @Component 등
dependencies = analyze_bean_dependencies(classes_list, beans)  # DI 관계
endpoints = extract_endpoints_from_classes(classes_list)  # @RestController
mybatis_mappers = extract_mybatis_mappers_from_classes(classes_list)  # @Mapper
jpa_entities = extract_jpa_entities_from_classes(classes_list)  # @Entity
jpa_repositories = extract_jpa_repositories_from_classes(classes_list)  # JpaRepository
jpa_queries = extract_jpa_queries_from_repositories(jpa_repositories)
config_files = extract_config_files(directory)  # application.yml 등
test_classes = extract_test_classes_from_classes(classes_list)  # @Test
```

### 4.5 MyBatis XML 매퍼 파싱
```python
xml_mappers = extract_mybatis_xml_mappers(directory, project_name, graph_db)
mybatis_mappers.extend(xml_mappers)
sql_statements = extract_sql_statements_from_mappers(mybatis_mappers, project_name)
```

- `src/main/resources/**/*.xml` 파일에서 SQL 추출

### 4.6 반환 (JavaAnalysisArtifacts)
```python
return (
    packages,           # Package 노드 리스트
    classes_list,       # Class 노드 리스트
    class_to_package_map,
    beans,              # Bean 노드 리스트
    dependencies,       # Bean 의존성 관계
    endpoints,          # Endpoint 노드 리스트
    mybatis_mappers,    # MyBatisMapper 노드 리스트
    jpa_entities,       # JpaEntity 노드 리스트
    jpa_repositories,   # JpaRepository 노드 리스트
    jpa_queries,        # JpaQuery 리스트
    config_files,       # ConfigFile 노드 리스트
    test_classes,       # TestClass 노드 리스트
    sql_statements,     # SqlStatement 노드 리스트
    project_name,
)
```

---

## 5단계: Neo4j 데이터베이스 저장

**파일**: `csa/services/analysis/neo4j_writer.py:304-381`

### 5.1 통계 계산
```python
java_stats = calculate_java_statistics(artifacts.*)  # neo4j_writer.py:316-328
```

### 5.2 Neo4j 연결 (필요시)
```python
if db is None:
    db = connect_to_neo4j_db(...)  # neo4j_writer.py:331-342
```

### 5.3 Project 노드 생성
```python
project = Project(
    name=project_name,
    display_name=project_name,
    language="Java",
    framework="Spring Boot",
    ...
)
db.add_project(project)  # neo4j_writer.py:344-356
```

### 5.4 Package 노드 저장
```python
_add_packages(db, artifacts.packages, project_name, logger)  # neo4j_writer.py:358
```

- Cypher: `CREATE (p:Package {name: $name, project_name: $project_name})`

### 5.5 Class 노드 저장 (진행률 표시)
```python
_add_classes(db, artifacts.classes, class_to_package_map, project_name, concurrent, workers, logger)  # neo4j_writer.py:359
```

**처리**: `neo4j_writer.py:280-302`
- 10% 단위로 진행률 로깅
- 각 클래스마다:
  ```cypher
  CREATE (c:Class {
      name: $name,
      logical_name: $logical_name,
      type: $type,
      sub_type: $sub_type,
      package_name: $package_name,
      project_name: $project_name,
      ...
  })
  ```
- Method, Field 노드도 함께 생성
- `BELONGS_TO` 관계: `(Class)-[:BELONGS_TO]->(Package)`
- `HAS_METHOD` 관계: `(Class)-[:HAS_METHOD]->(Method)`
- `HAS_FIELD` 관계: `(Class)-[:HAS_FIELD]->(Field)`
- `CALLS` 관계: `(Method)-[:CALLS]->(Method)`

### 5.6 Spring Boot 객체 저장
```python
add_springboot_objects(
    db,
    artifacts.beans,
    artifacts.dependencies,
    artifacts.endpoints,
    artifacts.mybatis_mappers,
    artifacts.jpa_entities,
    ...
)  # neo4j_writer.py:360-374
```

**처리**: `neo4j_writer.py:111-210`

#### 5.6.1 Bean 저장
```python
for idx, bean in enumerate(beans, 1):
    db.add_bean(bean, project_name)
    # 10% 단위 진행률 표시
```

#### 5.6.2 Bean Dependency 저장
```python
for dependency in dependencies:
    db.add_bean_dependency(dependency, project_name)
```
- `(Bean)-[:INJECTS]->(Bean)` 관계 생성

#### 5.6.3 Endpoint 저장
```python
for endpoint in endpoints:
    db.add_endpoint(endpoint, project_name)
```
- `@GetMapping("/api/users")` → Endpoint 노드

#### 5.6.4 MyBatis Mapper 저장
```python
for mapper in mybatis_mappers:
    db.add_mybatis_mapper(mapper, project_name)
```

#### 5.6.5 JPA Entity 저장
```python
for entity in jpa_entities:
    db.add_jpa_entity(entity, project_name)
```
- `@Entity` → JpaEntity 노드
- `(JpaEntity)-[:MAPS_TO]->(Table)` 관계 (DB 분석 완료 시)

#### 5.6.6 SQL Statement 저장 (진행률 표시)
```python
for idx, sql_statement in enumerate(sql_statements, 1):
    db.add_sql_statement(sql_statement, project_name)
    # Mapper와 SQL 관계 생성
    session.execute_write(
        db._create_mapper_sql_relationship_tx,
        sql_statement.mapper_name,
        sql_statement.id,
        project_name,
    )
```
- `(MyBatisMapper)-[:HAS_SQL]->(SqlStatement)` 관계
- `(SqlStatement)-[:USES_TABLE]->(Table)` 관계 (테이블 정보 포함 시)

---

## 6단계: 저장 통계 출력

**파일**: `csa/services/analysis/summary.py:104-240`

### 6.1 Java 분석 결과
```
[Java Object 분석 결과]
  - Project: myproject
  - Java 파일: 150/150개 (성공률: 100.0%)
  - Packages: 25개
  - Classes: 120개
  - Methods: 580개
  - Fields: 320개
  - Spring Beans: 45개
  - REST Endpoints: 32개
  - MyBatis Mappers: 15개
  - JPA Entities: 20개
  - SQL Statements: 85개
```

### 6.2 Neo4j 실제 저장 통계 (2025-10-17 추가됨)
```
[Neo4j Database 저장 현황]
전체 데이터베이스 저장 객체:
  - 총 노드 수: 8,420개
  - 총 관계 수: 14,811개

현재 프로젝트(myproject) 저장 객체:
  - 노드 수: 6,819개
  - 관계 수: 7,893개

라벨별 노드 수 (전체):
  - Method: 5,432개
  - Field: 3,210개
  - Class: 1,234개
  - Table: 456개
  ...

관계 타입별 수 (전체):
  - HAS_METHOD: 5,432개
  - CALLS: 12,345개
  - HAS_FIELD: 3,210개
  ...
```

---

## 핵심 데이터 흐름 요약

```
Java 소스 코드 (.java 파일)
    ↓ javalang.parse.parse()
AST (Abstract Syntax Tree)
    ↓ parse_java_project_full()
Pydantic 도메인 모델 (Class, Method, Field, Bean, etc.)
    ↓ JavaAnalysisArtifacts
save_java_objects_to_neo4j()
    ↓ GraphDB.add_*() 메서드들
Neo4j 그래프 데이터베이스
    ↓ Cypher 쿼리
노드 (Package, Class, Method, Bean, etc.)
관계 (BELONGS_TO, HAS_METHOD, CALLS, INJECTS, etc.)
```

---

## 주요 Neo4j 노드 타입

- **Project**: 프로젝트 정보
- **Package**: Java 패키지
- **Class**: 클래스/인터페이스
- **Method**: 메서드
- **Field**: 필드/속성
- **Bean**: Spring Bean (@Service, @Component 등)
- **Endpoint**: REST API 엔드포인트
- **MyBatisMapper**: MyBatis 매퍼
- **SqlStatement**: SQL 문
- **JpaEntity**: JPA 엔티티
- **JpaRepository**: JPA 리포지토리
- **ConfigFile**: 설정 파일
- **TestClass**: 테스트 클래스
- **Table**: DB 테이블 (DB 분석 결과)
- **Column**: DB 컬럼

## 주요 관계 타입

- **BELONGS_TO**: Class → Package
- **HAS_METHOD**: Class → Method
- **HAS_FIELD**: Class → Field
- **CALLS**: Method → Method (호출 관계)
- **INJECTS**: Bean → Bean (DI 관계)
- **MAPS_TO**: JpaEntity → Table
- **USES_TABLE**: SqlStatement → Table
- **HAS_SQL**: MyBatisMapper → SqlStatement

---

## 주요 파일 및 역할

| 파일 경로 | 역할 |
|----------|------|
| `csa/cli/commands/analyze.py` | CLI 명령 진입점 |
| `csa/services/analysis/handlers.py` | 분석 오케스트레이션 (DB/Java 분석 순서 제어) |
| `csa/services/analysis/java_pipeline.py` | Java 분석 파이프라인 |
| `csa/services/java_analysis/project.py` | Java 프로젝트 파싱 핵심 로직 (AST 변환) |
| `csa/services/java_analysis/spring.py` | Spring Boot Bean, Endpoint 추출 |
| `csa/services/java_analysis/mybatis.py` | MyBatis Mapper, SQL 추출 |
| `csa/services/java_analysis/jpa.py` | JPA Entity, Repository 추출 |
| `csa/services/analysis/neo4j_writer.py` | Neo4j 데이터베이스 저장 로직 |
| `csa/services/analysis/summary.py` | 분석 결과 통계 출력 |
| `csa/services/graph_db/` | Neo4j CRUD 작업 모듈 |

---

## 최근 변경 사항 (2025-10-17)

1. **분석 순서 변경**: DB 분석 → Java 분석 순서로 변경
   - 목적: JPA Entity, MyBatis 매퍼가 테이블 노드를 참조할 수 있도록

2. **Neo4j 실제 저장 통계 추가**:
   - 전체 DB 통계 조회 기능 추가
   - 프로젝트별 통계 비교 기능 추가
   - 라벨별, 관계 타입별 상세 통계 출력

---

이 전체 프로세스를 통해 Java 프로젝트의 모든 구조와 관계가 Neo4j 그래프 데이터베이스에 저장되어, 시퀀스 다이어그램 생성, CRUD 매트릭스 분석, 호출 체인 분석 등에 활용됩니다.
