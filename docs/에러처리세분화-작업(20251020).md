# 에러 처리 범위 세분화 작업

**작성일**: 2025-10-20
**작업자**: Claude Code
**우선순위**: 🟢 Low
**예상 시간**: 1시간

---

## 📋 작업 개요

`generate_spec()` 메서드의 너무 넓은 try-catch 범위를 단계별로 세분화하여 에러 발생 지점을 명확히 파악하고 부분적인 실패 처리를 가능하게 합니다.

---

## 🐛 문제 상황

### 현재 코드
```python
# generator.py:58-124
try:
    # 1. 클래스 정보 조회
    class_info = self.repository.get_class_info(...)

    # 2. 메서드 정보 조회
    methods_data = self.repository.get_methods(...)

    # 3. 필드 정보 조회
    fields_data = self.repository.get_fields(...)

    # 4. 의존성 정보 조회
    dependencies_data = self.repository.get_dependencies(...)

    # 5. CRUD 정보 조회 (옵션)
    crud_data = []
    if options.include_crud_info:
        crud_data = self.repository.get_crud_info(...)

    # 6-8. 데이터 모델 구성, 템플릿 렌더링, 파일 저장
    ...

except Exception as e:
    logger.error(f"Error generating class specification: {e}", exc_info=True)
    result["message"] = f"Error: {str(e)}"
```

### 문제점
1. **에러 위치 불명확**: 어느 단계에서 실패했는지 알기 어려움
2. **부분 실패 불가**: CRUD 정보 실패 시 전체 실패 (선택적 정보인데도)
3. **디버깅 어려움**: 로그만으로는 원인 파악 힘듦

---

## 🔧 해결 방안

### 단계별 에러 처리
```python
try:
    # 1. 클래스 정보 조회 (필수)
    class_info = self.repository.get_class_info(...)
    if not class_info:
        result["message"] = f"Class not found: {options.class_name}"
        logger.error(result["message"])
        return result

    logger.info(f"✓ Class information retrieved: {class_info['class_name']}")

    # 2-4. 필수 정보 조회
    try:
        methods_data = self.repository.get_methods(...)
        logger.info(f"✓ Methods retrieved: {len(methods_data)}")

        fields_data = self.repository.get_fields(...)
        logger.info(f"✓ Fields retrieved: {len(fields_data)}")

        dependencies_data = self.repository.get_dependencies(...)
        logger.info(f"✓ Dependencies retrieved: {len(dependencies_data)}")
    except Exception as e:
        logger.error(f"Error retrieving class details: {e}", exc_info=True)
        raise  # 필수 정보이므로 실패 시 중단

    # 5. CRUD 정보 조회 (선택적, 실패해도 계속 진행)
    crud_data = []
    if options.include_crud_info:
        try:
            crud_data = self.repository.get_crud_info(...)
            logger.info(f"✓ CRUD information retrieved: {len(crud_data)} tables")
        except Exception as e:
            logger.warning(f"Failed to retrieve CRUD info: {e}, continuing without it")
            # 실패해도 계속 진행

    # 6-8. 템플릿 처리
    try:
        spec_data = self._build_spec_data(...)
        spec_content = self.template.render(spec_data)
        file_path = self._save_spec(spec_content, spec_data, options.output_dir)
        logger.info(f"Specification saved to: {file_path}")
    except Exception as e:
        logger.error(f"Error generating specification document: {e}", exc_info=True)
        raise

    result["success"] = True
    result["message"] = "Class specification generated successfully"
    result["file_path"] = file_path
    ...

except Exception as e:
    logger.error(f"Error generating class specification: {e}", exc_info=True)
    result["message"] = f"Error: {str(e)}"
```

---

## 📝 수정 계획

### Step 1: 클래스 정보 조회 에러 처리 추가
**Before**:
```python
class_info = self.repository.get_class_info(...)
if not class_info:
    result["message"] = f"Class not found..."
    return result
```

**After** (로그 추가):
```python
class_info = self.repository.get_class_info(...)
if not class_info:
    result["message"] = f"Class not found: {options.class_name} in project {options.project_name}"
    logger.error(result["message"])
    return result

logger.info(f"✓ Class information retrieved: {class_info['class_name']}")
```

---

### Step 2: 필수 정보 조회 그룹화
**Before** (개별):
```python
methods_data = self.repository.get_methods(...)
logger.info(f"✓ Methods retrieved: {len(methods_data)}")

fields_data = self.repository.get_fields(...)
logger.info(f"✓ Fields retrieved: {len(fields_data)}")
```

**After** (try-catch로 그룹화):
```python
try:
    methods_data = self.repository.get_methods(...)
    logger.info(f"✓ Methods retrieved: {len(methods_data)}")

    fields_data = self.repository.get_fields(...)
    logger.info(f"✓ Fields retrieved: {len(fields_data)}")

    dependencies_data = self.repository.get_dependencies(...)
    logger.info(f"✓ Dependencies retrieved: {len(dependencies_data)}")
except Exception as e:
    logger.error(f"Error retrieving class details: {e}", exc_info=True)
    raise
```

---

### Step 3: CRUD 정보 조회 선택적 처리
**Before** (실패 시 전체 실패):
```python
crud_data = []
if options.include_crud_info:
    crud_data = self.repository.get_crud_info(...)
    logger.info(f"✓ CRUD information retrieved: {len(crud_data)} tables")
```

**After** (실패해도 계속 진행):
```python
crud_data = []
if options.include_crud_info:
    try:
        crud_data = self.repository.get_crud_info(...)
        logger.info(f"✓ CRUD information retrieved: {len(crud_data)} tables")
    except Exception as e:
        logger.warning(f"Failed to retrieve CRUD info: {e}, continuing without it")
        # 실패해도 계속 진행
```

---

### Step 4: 템플릿 처리 에러 처리
**Before**:
```python
spec_data = self._build_spec_data(...)
spec_content = self.template.render(spec_data)
file_path = self._save_spec(...)
```

**After**:
```python
try:
    spec_data = self._build_spec_data(...)
    spec_content = self.template.render(spec_data)
    file_path = self._save_spec(spec_content, spec_data, options.output_dir)
    logger.info(f"Specification saved to: {file_path}")
except Exception as e:
    logger.error(f"Error generating specification document: {e}", exc_info=True)
    raise
```

---

## 📊 효과

### 에러 메시지 개선
**Before**:
```
Error generating class specification: 'schema'
```

**After**:
```
Error retrieving class details: 'schema'
  OR
Failed to retrieve CRUD info: 'schema', continuing without it
  OR
Error generating specification document: 'schema'
```

### 견고성 향상
- CRUD 정보 실패해도 나머지 명세서 생성 가능
- 에러 발생 단계 즉시 파악

---

## ✅ 테스트 계획

### 1. 정상 케이스
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NotificationRepository
```

**기대 결과**:
- ✅ 모든 단계 성공
- ✅ 파일 정상 생성

### 2. 클래스 없는 경우
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NonExistentClass
```

**기대 결과**:
```
Error: Class not found: NonExistentClass in project car-center-devlab
```

### 3. CRUD 정보 실패 시
(Neo4j에서 CRUD 관련 데이터 없는 경우)

**기대 결과**:
- ⚠️ WARNING: Failed to retrieve CRUD info...
- ✅ 나머지 명세서 정상 생성

---

## 📋 체크리스트

- [ ] Step 1: 클래스 정보 조회 에러 처리 개선
- [ ] Step 2: 필수 정보 조회 그룹화
- [ ] Step 3: CRUD 정보 선택적 처리
- [ ] Step 4: 템플릿 처리 에러 처리
- [ ] 테스트 1: 정상 케이스
- [ ] 테스트 2: 클래스 없는 경우
- [ ] 테스트 3: 부분 실패 케이스
- [ ] Git commit

---

## 🎯 완료 기준

1. ✅ 에러 발생 단계 명확히 구분
2. ✅ 선택적 정보 실패 시 계속 진행
3. ✅ 로그 메시지 개선

---

## 📝 작업 로그

### 시작 시간
- 2025-10-20 21:15:00

### 종료 시간
- (작업 완료 후 기록)

### 실제 소요 시간
- (작업 완료 후 기록)

### 이슈/특이사항
- (작업 중 발견된 이슈 기록)
