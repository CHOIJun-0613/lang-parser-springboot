# Markdown 특수문자 이스케이프 추가 작업

**작성일**: 2025-10-20
**작업자**: Claude Code
**우선순위**: 🟢 Low
**예상 시간**: 30분

---

## 📋 작업 개요

Markdown 테이블 셀에 특수문자(특히 `|`, `\n`)가 포함될 경우 테이블 구조가 깨지는 문제를 방지합니다.

---

## 🐛 문제 상황

### 문제 시나리오
```java
// Java 코드
@JsonProperty(value="user|admin")  // ← 파이프 문자 포함
private Map<String, List<User>> data;  // ← 제네릭 타입
```

### 현재 코드
```python
# template.py:116
lines.append(
    f"| {idx} | {field.name} | {field.logical_name or '-'} | {field.type} | "
    f"{modifiers} | {annotations} | {initial_value} | {description} |"
)
```

### 생성된 Markdown (문제 발생)
```markdown
| 1 | data | 데이터 | Map<String, List<User>> | private | @JsonProperty(value="user|admin") | - | 사용자 데이터 |
```

**결과**: 파이프 문자로 인해 컬럼이 잘못 구분됨

---

## 🔧 해결 방안

### 헬퍼 메서드 추가
```python
def _escape_markdown_table_cell(self, text: str) -> str:
    """
    Markdown 테이블 셀 내 특수문자 이스케이프

    Args:
        text: 이스케이프할 텍스트

    Returns:
        이스케이프된 텍스트
    """
    if not text or text == '-':
        return text

    # 파이프 문자를 HTML 엔티티로 치환
    text = text.replace('|', '&#124;')

    # 줄바꿈을 공백으로 치환
    text = text.replace('\n', ' ').replace('\r', '')

    # 백틱을 이스케이프 (코드 블록 방지)
    text = text.replace('`', '\\`')

    return text
```

---

## 📝 수정 계획

### Step 1: 헬퍼 메서드 추가
**파일**: `csa/services/class_spec/template.py`

**위치**: ClassSpecTemplate 클래스 내부 (Line ~30)

---

### Step 2: 필드 렌더링에 적용
**파일**: `csa/services/class_spec/template.py:_render_fields()`

**Before**:
```python
lines.append(
    f"| {idx} | {field.name} | {field.logical_name or '-'} | {field.type} | "
    f"{modifiers} | {annotations} | {initial_value} | {description} |"
)
```

**After**:
```python
lines.append(
    f"| {idx} | {self._escape_markdown_table_cell(field.name)} | "
    f"{self._escape_markdown_table_cell(field.logical_name or '-')} | "
    f"{self._escape_markdown_table_cell(field.type)} | "
    f"{self._escape_markdown_table_cell(modifiers)} | "
    f"{self._escape_markdown_table_cell(annotations)} | "
    f"{self._escape_markdown_table_cell(initial_value)} | "
    f"{self._escape_markdown_table_cell(description)} |"
)
```

---

### Step 3: 메서드 렌더링에 적용
**파일**: `csa/services/class_spec/template.py:_render_method_group()`

**Before**:
```python
lines.append(
    f"| {idx} | {method.name} | {method.logical_name or '-'} | {method.return_type} | "
    f"{params_str} | {annotations} | {description} |"
)
```

**After**:
```python
lines.append(
    f"| {idx} | {self._escape_markdown_table_cell(method.name)} | "
    f"{self._escape_markdown_table_cell(method.logical_name or '-')} | "
    f"{self._escape_markdown_table_cell(method.return_type)} | "
    f"{self._escape_markdown_table_cell(params_str)} | "
    f"{self._escape_markdown_table_cell(annotations)} | "
    f"{self._escape_markdown_table_cell(description)} |"
)
```

---

### Step 4: 파라미터 렌더링에 적용
**파일**: `csa/services/class_spec/template.py:_render_method_detail()`

**Before**:
```python
lines.append(
    f"| {idx} | {param.name} | {param.logical_name or '-'} | {param.type} | "
    f"{required} | {param.description or '-'} |"
)
```

**After**:
```python
lines.append(
    f"| {idx} | {self._escape_markdown_table_cell(param.name)} | "
    f"{self._escape_markdown_table_cell(param.logical_name or '-')} | "
    f"{self._escape_markdown_table_cell(param.type)} | "
    f"{required} | {self._escape_markdown_table_cell(param.description or '-')} |"
)
```

---

### Step 5: 의존성/테이블 렌더링에 적용
기타 테이블 출력 부분에도 동일하게 적용

---

## ✅ 테스트 계획

### 1. 특수문자 포함 데이터 테스트
```python
# 테스트용 모델 생성
field = FieldSpec(
    name="data",
    type="Map<String, List<User>>",
    annotations=["@JsonProperty(value=\"user|admin\")"],
    description="사용자|관리자 데이터\n여러 줄"
)

template = ClassSpecTemplate()
result = template._escape_markdown_table_cell(field.type)
assert "&#124;" not in result  # Map<String, List<User>>는 파이프 없음

result = template._escape_markdown_table_cell(field.annotations[0])
assert "&#124;" in result  # @JsonProperty(value="user&#124;admin")

result = template._escape_markdown_table_cell(field.description)
assert "\n" not in result  # 줄바꿈 제거됨
```

### 2. 통합 테스트
```bash
python -m csa.cli.main class-spec \
  --project-name car-center-devlab \
  --class-name NotificationRepository
```

**기대 결과**:
- ✅ Markdown 파일 정상 생성
- ✅ 테이블 구조 유지
- ✅ GitHub/IDE에서 렌더링 정상

---

## 📊 영향 범위

### 수정 파일
- `csa/services/class_spec/template.py` (1개 파일)

### 수정 메서드
- `_escape_markdown_table_cell()` - 신규 추가
- `_render_fields()` - 적용
- `_render_method_group()` - 적용
- `_render_method_detail()` - 적용
- `_render_dependencies()` - 적용
- `_render_database_info()` - 적용

### 예상 라인 수
- **Before**: ~300줄
- **After**: ~350줄 (헬퍼 + 이스케이프 적용)
- **증가**: +50줄 (17%)

---

## 📋 체크리스트

- [ ] Step 1: `_escape_markdown_table_cell()` 헬퍼 추가
- [ ] Step 2: `_render_fields()` 적용
- [ ] Step 3: `_render_method_group()` 적용
- [ ] Step 4: `_render_method_detail()` 적용
- [ ] Step 5: 기타 테이블 렌더링 적용
- [ ] 테스트 1: 단위 테스트 (선택)
- [ ] 테스트 2: 통합 테스트 (필수)
- [ ] Markdown 렌더링 확인
- [ ] Git commit

---

## 🎯 완료 기준

1. ✅ 특수문자 이스케이프 처리
2. ✅ 테이블 구조 유지
3. ✅ 기존 기능 정상 작동

---

## 📝 작업 로그

### 시작 시간
- 2025-10-20 21:10:00

### 종료 시간
- (작업 완료 후 기록)

### 실제 소요 시간
- (작업 완료 후 기록)

### 이슈/특이사항
- (작업 중 발견된 이슈 기록)
